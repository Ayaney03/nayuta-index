# 無明会レター 3日間タイマー設定ガイド

## 概要
ユーザーが初回訪問してから3日後に自動的にページが「募集終了」画面に切り替わるタイマー機能を実装しました。
Utageの管理画面には影響を与えず、ユーザー向けページでのみ動作します。

## ファイル構成

### 1. timer_controller.js
- **役割**: タイマー機能の中核となるスクリプト
- **機能**: 
  - 管理画面とユーザーページの自動判別
  - 初回訪問時刻の記録（localStorage使用）
  - 3日間のカウントダウン表示
  - 期限切れ時の自動ページ切り替え

### 2. レター最終版_タイマー付き.html
- **役割**: 完全版のレターページ
- **特徴**: 
  - timer_controller.jsを最優先で読み込み
  - 既存のデザインとアニメーションを維持
  - 複数箇所にカウントダウンタイマーを配置

## Utageでの設定方法

### ステップ1: ファイルのアップロード
1. Utageの管理画面にログイン
2. 「ファイル管理」または「メディアライブラリ」に移動
3. 以下のファイルをアップロード：
   - `timer_controller.js`
   - `letter_scripts.js`（既存のアニメーション用）
   - `letter_styles.css`（既存のスタイル用）

### ステップ2: HTMLページの設定
1. 新しいページを作成または既存ページを編集
2. `レター最終版_タイマー付き.html`の内容をコピー
3. ファイルパスを適切に修正：
   ```html
   <!-- 例：Utageのファイルパスに合わせて修正 -->
   <script src="/path/to/timer_controller.js"></script>
   <script src="/path/to/letter_scripts.js"></script>
   <link rel="stylesheet" href="/path/to/letter_styles.css">
   ```

### ステップ3: 動作確認
1. プレビュー機能でページを確認
2. 管理画面では通常通り表示されることを確認
3. ユーザー向けURLでタイマーが動作することを確認

## 重要な特徴

### 🔒 管理画面保護機能
- URLパス、ドメイン、クエリパラメータで管理画面を自動判別
- iframe内実行、特定のクラス・ID存在も検出
- 管理画面ではタイマー機能を完全に無効化

### ⏰ 高精度タイマー機能
- 初回訪問時刻をlocalStorageに永続保存
- ブラウザを閉じても時間が継続
- 複数のタイマー表示を同期更新

### 🎨 期限切れ時の表示
- 3日経過後、自動的に「募集終了」ページに切り替え
- 公式アカウントへの誘導を含む美しいデザイン
- 一度期限切れになると、再訪問時も終了画面を表示

## デバッグ機能

### ブラウザコンソールでの操作
```javascript
// 残り時間を確認
getMumyokaiRemainingTime()

// タイマーをリセット（テスト用）
resetMumyokaiTimer()

// 現在の設定を確認
console.log(localStorage.getItem('mumyokai_timer_start'))
console.log(localStorage.getItem('mumyokai_expired'))
```

## カスタマイズ可能な設定

### timer_controller.js内で変更可能な項目：

```javascript
// タイマー期間（日数）
this.duration = 3; // 3日間 → 任意の日数に変更可能

// ローカルストレージのキー名
this.storageKey = 'mumyokai_timer_start'; // 必要に応じて変更

// 管理画面判定の条件
// detectAdminPanel()メソッド内で追加の判定条件を設定可能
```

### 期限切れページのデザイン
`getExpiredPageHTML()`メソッド内でHTMLを自由にカスタマイズ可能

## トラブルシューティング

### よくある問題と解決方法

1. **タイマーが動作しない**
   - ファイルパスが正しいか確認
   - ブラウザのJavaScript実行が有効か確認
   - コンソールエラーをチェック

2. **管理画面でもタイマーが動く**
   - 管理画面のURL構造を確認
   - `detectAdminPanel()`メソッドに追加の判定条件を設定

3. **時間がリセットされる**
   - localStorageが有効か確認
   - プライベートブラウジングモードでないか確認

4. **期限切れ後も通常ページが表示される**
   - localStorageの値を確認
   - `mumyokai_expired`キーの存在をチェック

## セキュリティ考慮事項

- localStorageを使用するため、ユーザーが手動でデータを削除可能
- 完全にサーバーサイドで制御したい場合は、別途バックエンド実装が必要
- 現在の実装はフロントエンド完結型で、Utageのシステムに依存しない

## 今後の拡張可能性

1. **サーバーサイド連携**
   - Utage APIとの連携でより確実な制御
   - ユーザー毎の個別期限設定

2. **アナリティクス連携**
   - 訪問時刻、期限切れ時刻の記録
   - コンバージョン率の測定

3. **A/Bテスト対応**
   - 期間の異なる複数パターンのテスト
   - 動的な期間調整機能

---

このシステムにより、Utageの管理画面に影響を与えることなく、ユーザー向けページでのみ3日間の期限付きタイマーが動作します。

