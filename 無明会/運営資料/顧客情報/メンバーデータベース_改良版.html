<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👥 無明会 メンバーデータベース</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f8f6f3 0%, #fff8dc 50%, #f5e6a3 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ヘッダー & 統計エリア（2カラム） */
        .header-stats {
            display: grid; 
            grid-template-columns: 1fr 2fr; 
            gap: 20px; 
            margin: 20px 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            border-radius: 12px; 
            color: white;
        }

        .header-info h1 {
            font-size: 1.8em; 
            margin: 0 0 8px 0;
        }

        .header-info h2 {
            font-size: 1.2em; 
            margin: 0 0 12px 0; 
            opacity: 0.9;
        }

        .header-info p {
            margin: 0; 
            opacity: 0.8; 
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15); 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 1.4em; 
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.75em; 
            opacity: 0.9;
        }

        /* フィルター */
        .filters {
            background: white;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }

        /* 三毒チーム統計 */
        .team-stats {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
        }

        .team-stats h3 {
            color: #6f42c1;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.85em;
        }

        .team-card {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .team-貪欲 { background: #ffc107; color: #856404; }
        .team-瞋恚 { background: #dc3545; }
        .team-愚痴 { background: #28a745; }
        .team-なし { background: #6c757d; }
        .team-未設定 { background: #e9ecef; color: #666; }

        /* メンバーリスト */
        .member-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .member-header {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            display: grid;
            grid-template-columns: 50px 150px 100px 80px 100px 100px 120px;
            gap: 10px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .member-header.with-rank {
            grid-template-columns: 40px 50px 150px 100px 80px 100px 100px 120px;
        }

        .member-item {
            padding: 8px 15px;
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: 50px 150px 100px 80px 100px 100px 120px;
            gap: 10px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .member-item.with-rank {
            grid-template-columns: 40px 50px 150px 100px 80px 100px 100px 120px;
        }

        .rank-number {
            text-align: center;
            font-weight: bold;
            color: #6f42c1;
        }

        .member-item:hover {
            background-color: #f8f9fa;
        }

        .member-item.faded {
            opacity: 0.6;
        }

        /* ステータス色 */
        .status-年間 { color: #28a745; font-weight: bold; }
        .status-通常 { color: #17a2b8; font-weight: bold; }
        .status-体験中 { color: #007bff; font-weight: bold; }
        .status-体験終了 { color: #ffc107; }
        .status-退会 { color: #dc3545; }

        /* チーム表示 */
        .team-display {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            color: white;
        }

        .team-display.team-貪欲 { background: #ffc107; color: #856404; }
        .team-display.team-瞋恚 { background: #dc3545; }
        .team-display.team-愚痴 { background: #28a745; }
        .team-display.team-なし { background: #6c757d; }
        .team-display.team-未設定 { background: #e9ecef; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー & 統計 -->
        <div class="header-stats">
            <div class="header-info">
                <h1>👥 無明会</h1>
                <h2>メンバーデータベース</h2>
                <p>メンバー管理・LTV分析システム</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-members">0</div>
                    <div class="stat-label">👥 総メンバー</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="annual-members">0</div>
                    <div class="stat-label">💎 年間会員</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="regular-members">0</div>
                    <div class="stat-label">⭐ 通常会員</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="trial-members">0</div>
                    <div class="stat-label">🔵 体験中</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="trial-ended">0</div>
                    <div class="stat-label">⏰ 体験終了</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="churned">0</div>
                    <div class="stat-label">❌ 退会</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-ltv">¥0M</div>
                    <div class="stat-label">💰 現役LTV</div>
                </div>
            </div>
        </div>

        <!-- フィルター -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-item">
                    <label>🔍 検索:</label>
                    <input type="text" id="searchBox" placeholder="名前で検索..." style="width: 200px;">
                </div>
                <div class="filter-item">
                    <label>ステータス:</label>
                    <select id="statusFilter">
                        <option value="">全て</option>
                        <option value="年間">年間会員</option>
                        <option value="通常">通常会員</option>
                        <option value="体験終了">体験終了</option>
                        <option value="退会">退会</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>チーム:</label>
                    <select id="teamFilter">
                        <option value="">全て</option>
                        <option value="貪欲">貪欲チーム</option>
                        <option value="瞋恚">瞋恚チーム</option>
                        <option value="愚痴">愚痴チーム</option>
                        <option value="なし">チーム未所属</option>
                        <option value="未設定">未設定</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>並び順:</label>
                    <select id="sortBy">
                        <option value="id">ID順</option>
                        <option value="name">名前順</option>
                        <option value="ltv-high">LTV高い順</option>
                        <option value="ltv-low">LTV低い順</option>
                        <option value="total-ltv-high">総LTV高い順</option>
                        <option value="total-ltv-low">総LTV低い順</option>
                        <option value="upsell-high">アップセル高い順</option>
                    </select>
                </div>
                <button class="btn-success" id="activeOnlyBtn">👥 現役会員のみ</button>
                <button class="btn-primary" id="ltvRankingBtn">🏆 LTVランキング</button>
            </div>
        </div>

        <!-- 三毒チーム統計 -->
        <div class="team-stats">
            <h3>🔮 三毒チーム分布</h3>
            <div class="team-grid">
                <div class="team-card team-貪欲">
                    <div id="greed-count">0</div>
                    <div>貪欲チーム</div>
                </div>
                <div class="team-card team-瞋恚">
                    <div id="anger-count">0</div>
                    <div>瞋恚チーム</div>
                </div>
                <div class="team-card team-愚痴">
                    <div id="ignorance-count">0</div>
                    <div>愚痴チーム</div>
                </div>
                <div class="team-card team-なし">
                    <div id="no-team-count">0</div>
                    <div>チーム未所属</div>
                </div>
                <div class="team-card team-未設定">
                    <div id="unassigned-count">0</div>
                    <div>未設定</div>
                </div>
            </div>
        </div>

        <!-- メンバーリスト -->
        <div class="member-list">
            <div class="member-header">
                <div id="rankHeader" style="display: none;">順位</div>
                <div>ID</div>
                <div>名前</div>
                <div>ステータス</div>
                <div>三毒チーム</div>
                <div>基本LTV</div>
                <div>アップセル</div>
                <div>総LTV</div>
            </div>
            <div id="memberGrid">
                <!-- メンバー一覧がここに表示されます -->
            </div>
        </div>
    </div>

    <script>
        // CSVファイルからデータを読み込む
        let members = [];
        let filteredMembers = [];
        let showActiveOnly = false;

        // CSVデータの読み込み
        // CSVを解析する関数（カンマを含む値に対応）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        async function loadMembersFromCSV() {
            try {
                console.log('CSVファイル読み込み開始');
                const response = await fetch('members_data.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV読み込み成功、テキスト長:', csvText.length);
                
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log('総行数:', lines.length);
                
                const headers = parseCSVLine(lines[0]);
                console.log('CSVヘッダー:', headers);
                
                members = []; // 配列をリセット
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 5 && values[0] && values[1]) { // IDと名前があることを確認
                        const member = {
                            id: values[0] || '',
                            name: values[1] || '',
                            furigana: values[2] || '',
                            discord: values[3] || '',
                            discordId: values[4] || '',
                            status: values[5] || '',
                            joinDate: values[6] || '',
                            regularJoinDate: values[7] || '',
                            annualPaymentDate: values[8] || '',
                            team: values[9] || '未設定',
                            lastActive: values[10] || '',
                            events: parseInt(values[11]) || 0,
                            ltv: parseInt(values[12]) || 0,
                            tesseiShin: values[13] || '',
                            nhProduct: values[14] || '',
                            nhAmount: parseInt(values[15]) || 0,
                            nhDate: values[16] || '',
                            upsell: (values[13] === 'あり' ? 330000 : 0) + (parseInt(values[15]) || 0),
                            purchaseHistory: []
                        };
                        
                        // 購入履歴の生成
                        if (member.tesseiShin === 'あり') {
                            member.purchaseHistory.push({
                                date: '2025-06-01',
                                product: '徹底精進',
                                amount: 330000,
                                type: 'アップセル'
                            });
                        }
                        
                        if (member.nhProduct && member.nhAmount > 0) {
                            member.purchaseHistory.push({
                                date: member.nhDate,
                                product: member.nhProduct,
                                amount: member.nhAmount,
                                type: 'アップセル'
                            });
                        }
                        
                        members.push(member);
                    }
                }
                
                console.log('CSV読み込み完了:', members.length, '名');
                filteredMembers = [...members];
                return true;
                
            } catch (error) {
                console.error('CSV読み込みエラー:', error);
                console.log('120人のフォールバックデータを使用します');
                
                // 120人分のフォールバックデータ
                members = [
            { id: 'M001', name: '藤澤秀彰', status: '退会', team: '未設定', ltv: 650000, upsell: 0 },
            { id: 'M002', name: '鈴木裕介', status: '体験終了', team: '未設定', ltv: 9800, upsell: 0 },
            { id: 'M003', name: '福井康大', status: '年間', team: '貪欲', ltv: 720000, upsell: 0 },
            { id: 'M004', name: '俵健太郎', status: '年間', team: '瞋恚', ltv: 620000, upsell: 0 },
            { id: 'M005', name: '進藤勇輝', status: '通常', team: '愚痴', ltv: 780000, upsell: 0 },
            { id: 'M006', name: '佐藤諒駿', status: '体験終了', team: '未設定', ltv: 540000, upsell: 0 },
            { id: 'M007', name: '杉平涼', status: '通常', team: '愚痴', ltv: 320000, upsell: 0 },
            { id: 'M008', name: '松本和久', status: '退会', team: '未設定', ltv: 150000, upsell: 0 },
            { id: 'M009', name: '松田陽平', status: '通常', team: '瞋恚', ltv: 280000, upsell: 55000 },
            { id: 'M010', name: '井上純也', status: '退会', team: '未設定', ltv: 90000, upsell: 0 },
            { id: 'M011', name: '根塚陽己', status: '退会', team: '未設定', ltv: 60000, upsell: 0 },
            { id: 'M012', name: '藤原綜太郎', status: '年間', team: '貪欲', ltv: 880000, upsell: 0 },
            { id: 'M013', name: '石島秀峰', status: '体験終了', team: '未設定', ltv: 180000, upsell: 0 },
            { id: 'M014', name: '佐藤亜美', status: '年間', team: '愚痴', ltv: 760000, upsell: 0 },
            { id: 'M015', name: '塚本真伍', status: '退会', team: '未設定', ltv: 120000, upsell: 0 },
            { id: 'M016', name: '湊翔太郎', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M017', name: '鈴木菜摘', status: '退会', team: '未設定', ltv: 60000, upsell: 0 },
            { id: 'M018', name: '松島徹', status: '体験終了', team: '未設定', ltv: 90000, upsell: 0 },
            { id: 'M019', name: '粟津律子', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M020', name: '榎本高也', status: '体験終了', team: '未設定', ltv: 60000, upsell: 0 },
            { id: 'M021', name: '石垣吉規', status: '通常', team: 'なし', ltv: 170000, upsell: 0 },
            { id: 'M022', name: 'ブル', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M023', name: '鈴木康太', status: '年間', team: '貪欲', ltv: 480000, upsell: 0 },
            { id: 'M024', name: '奥村拓哉', status: '通常', team: 'なし', ltv: 320000, upsell: 0 },
            { id: 'M025', name: '池本湊了汰', status: '通常', team: 'なし', ltv: 240000, upsell: 0 },
            { id: 'M026', name: '松本竜季', status: '年間', team: '瞋恚', ltv: 400000, upsell: 0 },
            { id: 'M027', name: '西島颯人', status: '体験終了', team: '未設定', ltv: 60000, upsell: 0 },
            { id: 'M028', name: '山縣誠二', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M029', name: '綿貫桂太', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M030', name: '清水暁', status: '通常', team: '瞋恚', ltv: 120000, upsell: 0 },
            { id: 'M031', name: '中村意央里', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M032', name: '島守勇次', status: '体験終了', team: 'なし', ltv: 60000, upsell: 0 },
            { id: 'M033', name: '千吉良俊充', status: '通常', team: 'なし', ltv: 160000, upsell: 0 },
            { id: 'M034', name: '岩下未誉子', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M035', name: '安田滉一', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M036', name: '真木智之', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M037', name: '吉嵜俊一郎', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M038', name: '今井一真', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M039', name: '平野理絵', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M040', name: '内田泰文', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M041', name: '増田凌一', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M042', name: '新保友望奈', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M043', name: '市川佳奈', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M044', name: '渡邉智大', status: '年間', team: '愚痴', ltv: 600000, upsell: 0 },
            { id: 'M045', name: '泉田祐輝', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M046', name: '永井克幸', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M047', name: '茂木一幸', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M048', name: '松田圭右', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M049', name: '松村遼河', status: '通常', team: '愚痴', ltv: 320000, upsell: 0 },
            { id: 'M050', name: '平岩遼志', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M051', name: '佐藤一気', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M052', name: '照井紀臣', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M053', name: '坂詰宣人', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M054', name: '中悠太', status: '年間', team: '愚痴', ltv: 560000, upsell: 0 },
            { id: 'M055', name: '小林千泰', status: '通常', team: '愚痴', ltv: 280000, upsell: 0 },
            { id: 'M056', name: '廣田一敬', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M057', name: '鈴木智弘', status: '通常', team: '貪欲', ltv: 240000, upsell: 0 },
            { id: 'M058', name: '小島啓輔', status: '通常', team: '貪欲', ltv: 200000, upsell: 0 },
            { id: 'M059', name: '尾崎勇哉', status: '年間', team: '瞋恚', ltv: 520000, upsell: 0 },
            { id: 'M060', name: '佐々木透', status: '通常', team: 'なし', ltv: 160000, upsell: 0 },
            { id: 'M061', name: '小林和貴', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M062', name: '日高悠河', status: '通常', team: '瞋恚', ltv: 360000, upsell: 0 },
            { id: 'M063', name: '安田滉一', status: '年間', team: '瞋恚', ltv: 440000, upsell: 0 },
            { id: 'M064', name: '江口達宏', status: '年間', team: '愚痴', ltv: 640000, upsell: 0 },
            { id: 'M065', name: '東出教若', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M066', name: '出田竜也', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M067', name: '長田一', status: '通常', team: '愚痴', ltv: 400000, upsell: 0 },
            { id: 'M068', name: '市橋慎士', status: '年間', team: '瞋恚', ltv: 680000, upsell: 0 },
            { id: 'M069', name: '今井奎介', status: '通常', team: '貪欲', ltv: 480000, upsell: 0 },
            { id: 'M070', name: '中西航平', status: '通常', team: '貪欲', ltv: 320000, upsell: 0 },
            { id: 'M071', name: '熊谷瑞奈美', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M072', name: '内野真子', status: '通常', team: '貪欲', ltv: 240000, upsell: 0 },
            { id: 'M073', name: '稲垣真裕', status: '年間', team: '瞋恚', ltv: 720000, upsell: 0 },
            { id: 'M074', name: '清田宇宙', status: '通常', team: 'なし', ltv: 200000, upsell: 0 },
            { id: 'M075', name: '猪野倫哉', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M076', name: '松垣友', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M077', name: '篠崎弘多', status: '通常', team: '瞋恚', ltv: 280000, upsell: 0 },
            { id: 'M078', name: '市村智', status: '年間', team: '愚痴', ltv: 760000, upsell: 0 },
            { id: 'M079', name: '今野大輔', status: '年間', team: '貪欲', ltv: 800000, upsell: 0 },
            { id: 'M080', name: '山縣誠二', status: '通常', team: '愚痴', ltv: 360000, upsell: 0 },
            { id: 'M081', name: '巾崎由紀子', status: '通常', team: '瞋恚', ltv: 440000, upsell: 0 },
            { id: 'M082', name: '籾山銀河', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M083', name: '坂詰宣人', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M084', name: '坂之上颯人', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M085', name: '氏家威吹', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M086', name: '黒柳朱音', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M087', name: '国安あずみ', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M088', name: '西島颯人', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M089', name: '阪本巳玖也', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M090', name: '坂本研太朗', status: '通常', team: 'なし', ltv: 520000, upsell: 0 },
            { id: 'M091', name: '藤井徹', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M092', name: '吉岡佑弥', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M093', name: '佐藤恭平', status: '通常', team: 'なし', ltv: 560000, upsell: 0 },
            { id: 'M094', name: '小渕桃子', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M095', name: '吉澤幸一', status: '通常', team: 'なし', ltv: 600000, upsell: 0 },
            { id: 'M096', name: '森岡裕之', status: '年間', team: '貪欲', ltv: 640000, upsell: 0 },
            { id: 'M097', name: '遠藤瑛太', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M098', name: '亀井悠', status: '年間', team: 'なし', ltv: 680000, upsell: 0 },
            { id: 'M099', name: '伊藤英哉', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M100', name: '小杉沙里衣', status: '通常', team: 'なし', ltv: 720000, upsell: 0 },
            { id: 'M101', name: '薄田京', status: '年間', team: '貪欲', ltv: 760000, upsell: 0 },
            { id: 'M102', name: '淺沼佳那子', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M103', name: '山田大将', status: '年間', team: '瞋恚', ltv: 800000, upsell: 0 },
            { id: 'M104', name: '永野福三', status: '通常', team: '瞋恚', ltv: 840000, upsell: 0 },
            { id: 'M105', name: '中根滉介', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M106', name: '山田剛', status: '通常', team: 'なし', ltv: 880000, upsell: 0 },
            { id: 'M107', name: '田原璃音', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M108', name: '淺利勇斗', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M109', name: '片山裕子', status: '年間', team: '貪欲', ltv: 920000, upsell: 0 },
            { id: 'M110', name: '水林麻里恵', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M111', name: '八木', status: '退会', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M112', name: '榎本知佳', status: '通常', team: '瞋恚', ltv: 960000, upsell: 0 },
            { id: 'M113', name: '畠田はな', status: '通常', team: '貪欲', ltv: 1000000, upsell: 0 },
            { id: 'M114', name: '上村徹雄', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M115', name: '渡邉敦子', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M116', name: '不明', status: '通常', team: 'なし', ltv: 1040000, upsell: 0 },
            { id: 'M117', name: '伊藤奏衣', status: '通常', team: '愚痴', ltv: 1080000, upsell: 0 },
            { id: 'M118', name: '片桐瞭', status: '通常', team: 'なし', ltv: 1120000, upsell: 0 },
            { id: 'M119', name: '渕上哲汰', status: '体験終了', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M120', name: '今泉', status: '通常', team: '瞋恚', ltv: 1160000, upsell: 0 },
            { id: 'M121', name: '宮崎弘登', status: '通常', team: '貪欲', ltv: 220000, upsell: 0 },
            { id: 'M122', name: '西島颯人', status: '体験終了', team: '未設定', ltv: 60000, upsell: 0 },
            { id: 'M123', name: '井沼さとみ', status: '体験中', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M124', name: '不明', status: '体験中', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M125', name: '不明', status: '体験中', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M126', name: '不明', status: '体験中', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M127', name: '南佳孝', status: '体験中', team: '未設定', ltv: 30000, upsell: 0 },
            { id: 'M128', name: 'ゆつ', status: '体験中', team: '未設定', ltv: 30000, upsell: 0 }
                ];
                
                filteredMembers = [...members];
                return false;
            }
        }

        // 統計の計算・更新
        function updateStats() {
            const total = filteredMembers.length;
            const annual = filteredMembers.filter(m => m.status === '年間').length;
            const regular = filteredMembers.filter(m => m.status === '通常').length;
            const trial = filteredMembers.filter(m => m.status === '体験中').length;
            const trialEnded = filteredMembers.filter(m => m.status === '体験終了').length;
            const churned = filteredMembers.filter(m => m.status === '退会').length;
            
            const activeLTV = filteredMembers
                .filter(m => m.status === '年間' || m.status === '通常')
                .reduce((sum, m) => sum + m.ltv, 0);

            // チーム統計
            const greedCount = filteredMembers.filter(m => m.team === '貪欲').length;
            const angerCount = filteredMembers.filter(m => m.team === '瞋恚').length;
            const ignoranceCount = filteredMembers.filter(m => m.team === '愚痴').length;
            const noTeamCount = filteredMembers.filter(m => m.team === 'なし').length;
            const unassignedCount = filteredMembers.filter(m => m.team === '未設定').length;

            // 統計表示更新
            document.getElementById('total-members').textContent = total;
            document.getElementById('annual-members').textContent = annual;
            document.getElementById('regular-members').textContent = regular;
            document.getElementById('trial-members').textContent = trial;
            document.getElementById('trial-ended').textContent = trialEnded;
            document.getElementById('churned').textContent = churned;
            document.getElementById('active-ltv').textContent = `¥${(activeLTV / 1000000).toFixed(1)}M`;

            // チーム統計更新
            document.getElementById('greed-count').textContent = greedCount;
            document.getElementById('anger-count').textContent = angerCount;
            document.getElementById('ignorance-count').textContent = ignoranceCount;
            document.getElementById('no-team-count').textContent = noTeamCount;
            document.getElementById('unassigned-count').textContent = unassignedCount;

            console.log('統計更新:', {total, annual, regular, activeLTV: (activeLTV/1000000).toFixed(1)+'M'});
        }



        // メンバー一覧の表示
        function renderMembers() {
            console.log('メンバー表示:', filteredMembers.length, '名');
            const grid = document.getElementById('memberGrid');
            const html = filteredMembers.map((member, index) => createMemberCard(member, index)).join('');
            grid.innerHTML = html;
            
            // ランキングヘッダーの表示/非表示制御
            const sortBy = document.getElementById('sortBy').value;
            const showRank = sortBy.includes('ltv') || sortBy.includes('upsell');
            const rankHeader = document.getElementById('rankHeader');
            const memberHeader = document.querySelector('.member-header');
            
            rankHeader.style.display = showRank ? 'block' : 'none';
            
            // グリッドレイアウトの調整
            if (showRank) {
                memberHeader.classList.add('with-rank');
            } else {
                memberHeader.classList.remove('with-rank');
            }
            
            // メンバーアイテムのクラスはcreateCardで処理されるため削除
        }

        // ソート機能
        function sortMembers() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredMembers.sort((a, b) => {
                switch (sortBy) {
                    case 'id':
                        return a.id.localeCompare(b.id);
                    case 'name':
                        return a.name.localeCompare(b.name, 'ja');
                    case 'ltv-high':
                        return b.ltv - a.ltv;
                    case 'ltv-low':
                        return a.ltv - b.ltv;
                    case 'total-ltv-high':
                        return (b.ltv + b.upsell) - (a.ltv + a.upsell);
                    case 'total-ltv-low':
                        return (a.ltv + a.upsell) - (b.ltv + b.upsell);
                    case 'upsell-high':
                        return b.upsell - a.upsell;
                    default:
                        return a.id.localeCompare(b.id);
                }
            });

            renderMembers();
        }

        // フィルタリング
        function filterMembers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;

            filteredMembers = members.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || member.status === statusFilter;
                const matchesTeam = !teamFilter || member.team === teamFilter;
                const matchesActiveFilter = !showActiveOnly || (member.status === '年間' || member.status === '通常');

                return matchesSearch && matchesStatus && matchesTeam && matchesActiveFilter;
            });

            sortMembers(); // フィルタ後にソート
            updateStats();
        }

        // 現役会員フィルター切り替え
        function toggleActiveOnly() {
            showActiveOnly = !showActiveOnly;
            const btn = document.getElementById('activeOnlyBtn');
            
            if (showActiveOnly) {
                btn.style.background = '#dc3545';
                btn.textContent = '🚫 全員表示';
            } else {
                btn.style.background = '#28a745';
                btn.textContent = '👥 現役会員のみ';
            }
            
            filterMembers();
        }

        // LTVランキング表示
        function showLTVRanking() {
            // 現役会員のみに絞り込み
            showActiveOnly = true;
            const activeBtn = document.getElementById('activeOnlyBtn');
            activeBtn.style.background = '#dc3545';
            activeBtn.textContent = '🚫 全員表示';
            
            // 総LTV高い順でソート
            document.getElementById('sortBy').value = 'total-ltv-high';
            
            // ヘッダーテキストを変更
            const rankHeader = document.getElementById('rankHeader');
            rankHeader.textContent = '🏆 順位';
            
            filterMembers();
            
            // ランキング表示メッセージ
            setTimeout(() => {
                alert('🏆 LTVランキング表示\n\n現役会員を総LTV高い順で表示しています。\n「並び順」で他の順序も選択できます。');
            }, 100);
        }

        // イベントリスナー設定
        function setupEventListeners() {
            document.getElementById('searchBox').addEventListener('input', filterMembers);
            document.getElementById('statusFilter').addEventListener('change', filterMembers);
            document.getElementById('teamFilter').addEventListener('change', filterMembers);
            document.getElementById('sortBy').addEventListener('change', sortMembers);
            document.getElementById('activeOnlyBtn').addEventListener('click', toggleActiveOnly);
            document.getElementById('ltvRankingBtn').addEventListener('click', showLTVRanking);
        }

        // メンバー詳細ページを開く
        function openMemberDetail(memberId) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                // メンバーデータをlocalStorageに保存
                localStorage.setItem(`member_${memberId}`, JSON.stringify(member));
                
                // 詳細ページに遷移
                window.open(`member_detail.html?id=${memberId}`, '_blank');
            }
        }

        // メンバーカードにクリックイベントを追加
        function createMemberCard(member, index) {
            const totalLTV = member.ltv + member.upsell;
            const upsellText = member.upsell > 0 ? `¥${member.upsell.toLocaleString()}` : '-';
            const fadedClass = (member.status === '退会' || member.status === '体験終了') ? 'faded' : '';
            
            const sortBy = document.getElementById('sortBy').value;
            const showRank = sortBy.includes('ltv') || sortBy.includes('upsell');
            const withRankClass = showRank ? 'with-rank' : '';
            const rankDisplay = showRank ? `<div class="rank-number">${index + 1}</div>` : '';
            
            return `
                <div class="member-item ${fadedClass} ${withRankClass}" onclick="openMemberDetail('${member.id}')" style="cursor: pointer;">
                    ${rankDisplay}
                    <div>${member.id}</div>
                    <div>${member.name}</div>
                    <div class="status-${member.status}">${member.status}</div>
                    <div><span class="team-display team-${member.team}">${member.team}</span></div>
                    <div>¥${member.ltv.toLocaleString()}</div>
                    <div>${upsellText}</div>
                    <div>¥${totalLTV.toLocaleString()}</div>
                </div>
            `;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ページ初期化開始');
            
            // CSVデータの読み込み
            await loadMembersFromCSV();
            
            renderMembers();
            updateStats();
            setupEventListeners();
            console.log('ページ初期化完了');
        });

        console.log('JavaScript読み込み完了');
    </script>
</body>
</html>
