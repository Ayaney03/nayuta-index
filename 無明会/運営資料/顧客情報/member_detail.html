<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É°„É≥„Éê„ÉºË©≥Á¥∞ - ÁÑ°Êòé‰ºö</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f8f6f3 0%, #fff8dc 50%, #f5e6a3 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .member-info {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .info-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .monthly-sales {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .monthly-table th,
        .monthly-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .monthly-table th {
            background: #2c3e50;
            color: white;
            font-weight: bold;
        }

        .monthly-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .status-Âπ¥Èñì {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .status-ÈÄöÂ∏∏ {
            background: #d1ecf1;
            color: #0c5460;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .status-ÈÄÄ‰ºö, .status-‰ΩìÈ®ìÁµÇ‰∫Ü {
            background: #495057;
            color: #fff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .upsale-info {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .upsale-title {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 10px;
        }

        /* ‰∏âÊØí„ÉÅ„Éº„É†„ÅÆËâ≤ÂàÜ„Åë */
        .team-Ë≤™Ê¨≤ { 
            background: #fff9c4; 
            color: #795548; 
            border: 1px solid #ffeb3b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-ÁûãÊÅö { 
            background: #ffebee; 
            color: #b71c1c; 
            border: 1px solid #f44336;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-ÊÑöÁó¥ { 
            background: #e8f5e8; 
            color: #2e7d32; 
            border: 1px solid #4caf50;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-„Å™„Åó { 
            background: #e9ecef; 
            color: #6c757d; 
            border: 1px solid #6c757d;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-Êú™Ë®≠ÂÆö { 
            background: #fff; 
            color: #999; 
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Ë≥ºÂÖ•Â±•Ê≠¥„Çπ„Çø„Ç§„É´ */
        .purchase-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 80px 1fr 100px 80px;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }

        .purchase-date {
            font-weight: bold;
            color: #495057;
        }

        .purchase-product {
            color: #212529;
        }

        .purchase-amount {
            text-align: right;
            font-weight: bold;
            color: #28a745;
        }

        .purchase-type {
            text-align: center;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .purchase-type.basic {
            background: #17a2b8;
            color: white;
        }

        .purchase-type.upsell {
            background: #ff6b35;
            color: white;
        }
    </style>
</head>
<body>
    <a href="„É°„É≥„Éê„Éº„Éá„Éº„Çø„Éô„Éº„Çπ.html" class="back-btn">‚Üê ‰∏ÄË¶ß„Å´Êàª„Çã</a>

    <div class="container">
        <div class="header">
            <h1 id="memberName">„É°„É≥„Éê„ÉºË©≥Á¥∞</h1>
            <p id="memberId"></p>
        </div>

        <!-- Ê§úÁ¥¢Ê©üËÉΩ -->
        <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff;">
            <h3 style="color: #007bff; margin-bottom: 10px; font-size: 1em;">üîç „É°„É≥„Éê„ÉºÊ§úÁ¥¢</h3>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="ÂêçÂâç„ÉªË™≠„Åø‰ªÆÂêç„ÉªDiscordÂêç„ÅßÊ§úÁ¥¢..." 
                       style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                <button onclick="searchMembers()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Ê§úÁ¥¢</button>
                <button onclick="clearSearch()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">„ÇØ„É™„Ç¢</button>
            </div>
            <div id="searchResults" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="member-info">
            <!-- Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="info-section">
                <h3>üìã Âü∫Êú¨ÊÉÖÂ†±</h3>
                <div class="info-row">
                    <span class="info-label">Ë™≠„Åø‰ªÆÂêç</span>
                    <span class="info-value" id="furigana"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">„Çπ„ÉÜ„Éº„Çø„Çπ</span>
                    <span class="info-value" id="status"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">‰∏âÊØí„ÉÅ„Éº„É†</span>
                    <span class="info-value" id="team"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÂÖ•‰ºöÊó•</span>
                    <span class="info-value" id="joinDate"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ê≠£Ë¶èÈñãÂßãÊó•</span>
                    <span class="info-value" id="regularJoinDate"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÊúÄÁµÇÊ¥ªÂãï</span>
                    <span class="info-value" id="lastActive"></span>
                </div>
            </div>

            <!-- LTVË©≥Á¥∞ÊÉÖÂ†± -->
            <div class="info-section">
                <h3>üí∞ LTVË©≥Á¥∞ÂÜÖË®≥</h3>
                <div id="ltvBreakdown" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <!-- LTVÂÜÖË®≥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
                <div class="info-row" style="border-top: 2px solid #007bff; margin-top: 10px; padding-top: 10px;">
                    <span class="info-label" style="font-weight: bold; font-size: 1.1em;">Á∑èLTV</span>
                    <span class="info-value" id="totalLTV" style="font-weight: bold; color: #007bff; font-size: 1.2em;"></span>
                </div>
            </div>

            <!-- „Ç¢„ÉÉ„Éó„Çª„É´Ë©≥Á¥∞ -->
            <div id="upsaleDetails" class="info-section" style="display: none;">
                <h3>üõí „Ç¢„ÉÉ„Éó„Çª„É´Ë©≥Á¥∞</h3>
                <div id="upsaleContent"></div>
            </div>

            <!-- DiscordÊÉÖÂ†± -->
            <div class="info-section">
                <h3>üí¨ DiscordÊÉÖÂ†±</h3>
                <div class="info-row">
                    <span class="info-label">DiscordÂêç</span>
                    <span class="info-value" id="discordName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Discord ID</span>
                    <span class="info-value" id="discordId"></span>
                </div>
            </div>

            <!-- Ë≥ºÂÖ•Â±•Ê≠¥ -->
            <div class="info-section">
                <h3>üõí Ë≥ºÂÖ•Â±•Ê≠¥</h3>
                <div id="purchaseHistory" style="margin-top: 10px;">
                    <!-- Ë≥ºÂÖ•Â±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>

            <!-- Â£≤‰∏äÂ±•Ê≠¥ -->
            <div class="monthly-sales">
                <div class="info-section">
                    <h3>üìä Â£≤‰∏äÂ±•Ê≠¥ÔºàÊó•Âà•Ôºâ</h3>
                    <div style="margin-bottom: 15px;">
                        <button onclick="addSalesRecord()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">+ Â£≤‰∏äË®òÈå≤ËøΩÂä†</button>
                        <button onclick="toggleView()" id="viewToggle" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px;">ÊúàÂà•Ë°®Á§∫</button>
                    </div>
                    
                    <!-- Êó•Âà•Ë©≥Á¥∞Ë°®Á§∫ -->
                    <div id="dailyView">
                        <table class="monthly-table">
                            <thead>
                                <tr>
                                    <th>Êó•‰ªò</th>
                                    <th>Â£≤‰∏äÁ®ÆÂà•</th>
                                    <th>ÈáëÈ°ç</th>
                                    <th>ÂÜÖÂÆπ</th>
                                    <th>ÊîØÊâïÊñπÊ≥ï</th>
                                    <th>ÂÇôËÄÉ</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="dailyData">
                                <!-- Êó•Âà•„Éá„Éº„Çø„Åå„Åì„Åì„Å´ÂãïÁöÑÁîüÊàê„Åï„Çå„Åæ„Åô -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ÊúàÂà•„Çµ„Éû„É™„ÉºË°®Á§∫ -->
                    <div id="monthlyView" style="display: none;">
                        <table class="monthly-table">
                            <thead>
                                <tr>
                                    <th>Âπ¥Êúà</th>
                                    <th>Âü∫Êú¨ÊñôÈáë</th>
                                    <th>„Ç¢„ÉÉ„Éó„Çª„É´</th>
                                    <th>„Åù„ÅÆ‰ªñ</th>
                                    <th>ÊúàË®à</th>
                                    <th>Ë©≥Á¥∞</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyData">
                                <!-- ÊúàÂà•„Éá„Éº„Çø„Åå„Åì„Åì„Å´ÂãïÁöÑÁîüÊàê„Åï„Çå„Åæ„Åô -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="three_poisons_team_mapping.js"></script>
    <script>
        // URL„Éë„É©„É°„Éº„Çø„Åã„Çâ„É°„É≥„Éê„ÉºID„ÇíÂèñÂæó
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');

        // „É°„É≥„Éê„Éº„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÅøÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Åß„ÅØÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâÔºâ
        let memberData = null;

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„É°„É≥„Éê„ÉºË©≥Á¥∞„ÇíË°®Á§∫
        document.addEventListener('DOMContentLoaded', function() {
            if (memberId) {
                // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Åß„ÅØ„ÄÅ„Åì„Åì„Åß„É°„É≥„Éê„Éº„Éá„Éº„Çø„ÇíÂèñÂæó
                loadMemberData(memberId);
            } else {
                alert('„É°„É≥„Éê„ÉºID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                window.location.href = '„É°„É≥„Éê„Éº„Éá„Éº„Çø„Éô„Éº„Çπ.html';
            }
        });

        // „É°„É≥„Éê„Éº„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÅøÔºàÁ∞°ÊòìÁâàÔºâ
        function loadMemberData(id) {
            // ÂÆüÈöõ„Å´„ÅØ„É°„É≥„Éê„Éº„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂèñÂæóÔºàlocalStorageÂà©Áî®ÊÉ≥ÂÆöÔºâ
            const memberFromDB = localStorage.getItem(`member_${id}`);
            if (memberFromDB) {
                const member = JSON.parse(memberFromDB);
                displayMemberDetail(member);
                return;
            }
            
            // ‰ªÆ„ÅÆ„Éá„Éº„ÇøÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Åß„ÅØ API „ÇÑ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæóÔºâ
            const sampleData = {
                id: id,
                name: 'ÊùæÁî∞ÈôΩÂπ≥',
                currentStatus: 'ÈÄöÂ∏∏',
                threePoisonsTeam: 'ÁûãÊÅö',
                joinDate: '2024-07-01',
                regularJoinDate: '2024-02-29',
                lastActive: '2025-07-29',
                baseLTV: 154000,
                upsaleLTV: 380000,
                totalLTV: 534000,
                discord: 'ÊùæÁî∞',
                discordId: 'matsuda123',
                upsales: [
                    {
                        name: 'ÂæπÂ∫ïÁ≤æÈÄ≤',
                        totalAmount: 330000,
                        purchaseDate: '2025-06',
                        installments: 3,
                        monthlyAmount: 110000,
                        paidInstallments: 2,
                        remainingAmount: 110000,
                        nextPaymentDate: '2025-08-31',
                        status: 'ÂàÜÂâ≤‰∏≠'
                    },
                    {
                        name: 'NHBC1Âπ¥VIP',
                        totalAmount: 50000,
                        purchaseDate: '2025-07-16',
                        installments: 1,
                        monthlyAmount: 50000,
                        paidInstallments: 1,
                        remainingAmount: 0,
                        nextPaymentDate: null,
                        status: 'ÂÆåÊ∏à'
                    }
                ],
                salesHistory: [
                    { date: '2024-07-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: 'ÂÖ•‰ºö', id: 1 },
                    { date: '2024-08-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 2 },
                    { date: '2024-09-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 3 },
                    { date: '2024-10-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 4 },
                    { date: '2024-11-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 5 },
                    { date: '2024-12-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 6 },
                    { date: '2025-01-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 7 },
                    { date: '2025-02-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 8 },
                    { date: '2025-03-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 9 },
                    { date: '2025-04-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 10 },
                    { date: '2025-05-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 11 },
                    { date: '2025-06-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 12 },
                    { date: '2025-06-15', type: '„Ç¢„ÉÉ„Éó„Çª„É´', amount: 110000, content: 'ÂæπÂ∫ïÁ≤æÈÄ≤', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: 'ÂàÜÂâ≤ 1/3', id: 13 },
                    { date: '2025-07-01', type: 'Âü∫Êú¨ÊñôÈáë', amount: 22000, content: 'ÈÄöÂ∏∏‰ºöÂì°', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '', id: 14 },
                    { date: '2025-07-16', type: '„Ç¢„ÉÉ„Éó„Çª„É´', amount: 50000, content: 'NHBC1Âπ¥VIP', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: '‰∏ÄÊã¨', id: 15 },
                    { date: '2025-07-31', type: '„Ç¢„ÉÉ„Éó„Çª„É´', amount: 110000, content: 'ÂæπÂ∫ïÁ≤æÈÄ≤', method: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', note: 'ÂàÜÂâ≤ 2/3', id: 16 },
                ]
            };

            displayMemberDetail(sampleData);
        }

        // „É°„É≥„Éê„ÉºË©≥Á¥∞„ÇíË°®Á§∫
        function displayMemberDetail(member) {
            memberData = member;

            // Âü∫Êú¨ÊÉÖÂ†±
            document.getElementById('memberName').textContent = member.name;
            document.getElementById('memberId').textContent = `ID: ${member.id}`;
            document.getElementById('status').innerHTML = `<span class="status-${member.currentStatus}">${member.currentStatus}</span>`;
            document.getElementById('team').innerHTML = `<span class="team-${member.threePoisonsTeam}">${member.threePoisonsTeam}</span>`;
            document.getElementById('joinDate').textContent = member.joinDate;
            document.getElementById('regularJoinDate').textContent = member.regularJoinDate;
            document.getElementById('lastActive').textContent = member.lastActive;

            // LTVË©≥Á¥∞ÂÜÖË®≥Ë°®Á§∫
            displayLTVBreakdown(member);

            // DiscordÊÉÖÂ†±
            document.getElementById('discordName').textContent = member.discord || '-';
            document.getElementById('discordId').textContent = member.discordId || '-';

            // Ë≥ºÂÖ•Â±•Ê≠¥Ë°®Á§∫
            displayPurchaseHistory(member);

            // „Ç¢„ÉÉ„Éó„Çª„É´Ë©≥Á¥∞
            if (member.upsales && member.upsales.length > 0) {
                const upsaleSection = document.getElementById('upsaleDetails');
                const upsaleContent = document.getElementById('upsaleContent');
                
                upsaleSection.style.display = 'block';
                
                member.upsales.forEach(upsale => {
                    const upsaleDiv = document.createElement('div');
                    upsaleDiv.className = 'upsale-info';
                    upsaleDiv.innerHTML = `
                        <div class="upsale-title">${upsale.name}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                            <div>Ë≥ºÂÖ•Êó•: ${upsale.purchaseDate}</div>
                            <div>Á∑èÈ°ç: ¬•${upsale.totalAmount.toLocaleString()}</div>
                            <div>ÂàÜÂâ≤: ${upsale.installments}Âõû</div>
                            <div>ÊúàÈ°ç: ¬•${upsale.monthlyAmount.toLocaleString()}</div>
                            <div>ÊîØÊâïÊ∏à: ${upsale.paidInstallments}/${upsale.installments}Âõû</div>
                            <div>ÊÆãÈ°ç: ¬•${upsale.remainingAmount.toLocaleString()}</div>
                            <div>Ê¨°Âõû: ${upsale.nextPaymentDate}</div>
                            <div>Áä∂ÊÖã: ${upsale.status}</div>
                        </div>
                    `;
                    upsaleContent.appendChild(upsaleDiv);
                });
            }

            // Êó•Âà•Â£≤‰∏äÂ±•Ê≠¥„ÇíË°®Á§∫
            displaySalesHistory();
        }

        // Ë°®Á§∫Âàá„ÇäÊõø„Åà
        let isMonthlyView = false;
        function toggleView() {
            const dailyView = document.getElementById('dailyView');
            const monthlyView = document.getElementById('monthlyView');
            const toggleBtn = document.getElementById('viewToggle');
            
            isMonthlyView = !isMonthlyView;
            
            if (isMonthlyView) {
                dailyView.style.display = 'none';
                monthlyView.style.display = 'block';
                toggleBtn.textContent = 'Êó•Âà•Ë°®Á§∫';
                generateMonthlySummary();
            } else {
                dailyView.style.display = 'block';
                monthlyView.style.display = 'none';
                toggleBtn.textContent = 'ÊúàÂà•Ë°®Á§∫';
            }
        }

        // Êó•Âà•Â£≤‰∏äÂ±•Ê≠¥„ÇíË°®Á§∫
        function displaySalesHistory() {
            const dailyTable = document.getElementById('dailyData');
            dailyTable.innerHTML = '';
            
            // Êó•‰ªò„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
            const sortedHistory = memberData.salesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedHistory.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span style="background: ${getTypeColor(record.type)}; padding: 2px 6px; border-radius: 3px; color: white; font-size: 0.8em;">${record.type}</span></td>
                    <td style="font-weight: bold;">¬•${record.amount.toLocaleString()}</td>
                    <td>${record.content}</td>
                    <td>${record.method}</td>
                    <td>${record.note}</td>
                    <td>
                        <button onclick="editSalesRecord(${record.id})" style="background: #ffc107; color: black; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; margin-right: 5px;">Á∑®ÈõÜ</button>
                        <button onclick="deleteSalesRecord(${record.id})" style="background: #dc3545; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer;">ÂâäÈô§</button>
                    </td>
                `;
                dailyTable.appendChild(row);
            });
        }

        // Â£≤‰∏äÁ®ÆÂà•„ÅÆËâ≤ÂàÜ„Åë
        function getTypeColor(type) {
            switch (type) {
                case 'Âü∫Êú¨ÊñôÈáë': return '#007bff';
                case '„Ç¢„ÉÉ„Éó„Çª„É´': return '#28a745';
                case 'Âπ¥ÈñìÊñôÈáë': return '#6f42c1';
                case '„Åù„ÅÆ‰ªñ': return '#6c757d';
                default: return '#6c757d';
            }
        }

        // ÊúàÂà•„Çµ„Éû„É™„Éº„ÇíÁîüÊàê
        function generateMonthlySummary() {
            const monthlyTable = document.getElementById('monthlyData');
            monthlyTable.innerHTML = '';
            
            // Êúà„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const monthlyData = {};
            memberData.salesHistory.forEach(record => {
                const month = record.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { base: 0, upsale: 0, other: 0, details: [] };
                }
                
                if (record.type === 'Âü∫Êú¨ÊñôÈáë' || record.type === 'Âπ¥ÈñìÊñôÈáë') {
                    monthlyData[month].base += record.amount;
                } else if (record.type === '„Ç¢„ÉÉ„Éó„Çª„É´') {
                    monthlyData[month].upsale += record.amount;
                } else {
                    monthlyData[month].other += record.amount;
                }
                
                monthlyData[month].details.push(record);
            });
            
            // ÊúàÂà•„Éá„Éº„Çø„ÇíË°®Á§∫ÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            sortedMonths.forEach(month => {
                const data = monthlyData[month];
                const total = data.base + data.upsale + data.other;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>¬•${data.base.toLocaleString()}</td>
                    <td>¬•${data.upsale.toLocaleString()}</td>
                    <td>¬•${data.other.toLocaleString()}</td>
                    <td style="font-weight: bold;">¬•${total.toLocaleString()}</td>
                    <td><button onclick="showMonthDetail('${month}')" style="background: #007bff; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer;">Ë©≥Á¥∞</button></td>
                `;
                monthlyTable.appendChild(row);
            });
        }

        // Â£≤‰∏äË®òÈå≤ËøΩÂä†
        function addSalesRecord() {
            const date = prompt('Êó•‰ªò„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (YYYY-MM-DD):');
            if (!date) return;
            
            const type = prompt('Â£≤‰∏äÁ®ÆÂà•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Âü∫Êú¨ÊñôÈáë/„Ç¢„ÉÉ„Éó„Çª„É´/Âπ¥ÈñìÊñôÈáë/„Åù„ÅÆ‰ªñ):');
            if (!type) return;
            
            const amount = prompt('ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!amount || isNaN(amount)) return;
            
            const content = prompt('ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!content) return;
            
            const method = prompt('ÊîØÊâïÊñπÊ≥ï„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ („ÇØ„É¨„Ç∏„ÉÉ„Éà/ÈäÄË°åÊåØËæº/ÁèæÈáë/„Åù„ÅÆ‰ªñ):');
            if (!method) return;
            
            const note = prompt('ÂÇôËÄÉ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (‰ªªÊÑè):') || '';
            
            const newRecord = {
                id: Math.max(...memberData.salesHistory.map(r => r.id)) + 1,
                date: date,
                type: type,
                amount: parseInt(amount),
                content: content,
                method: method,
                note: note
            };
            
            memberData.salesHistory.push(newRecord);
            displaySalesHistory();
            
            // LTVÂÜçË®àÁÆó
            recalculateLTV();
        }

        // Â£≤‰∏äË®òÈå≤Á∑®ÈõÜ
        function editSalesRecord(id) {
            const record = memberData.salesHistory.find(r => r.id === id);
            if (!record) return;
            
            const newDate = prompt('Êó•‰ªò:', record.date) || record.date;
            const newType = prompt('Â£≤‰∏äÁ®ÆÂà•:', record.type) || record.type;
            const newAmount = prompt('ÈáëÈ°ç:', record.amount) || record.amount;
            const newContent = prompt('ÂÜÖÂÆπ:', record.content) || record.content;
            const newMethod = prompt('ÊîØÊâïÊñπÊ≥ï:', record.method) || record.method;
            const newNote = prompt('ÂÇôËÄÉ:', record.note) || record.note;
            
            record.date = newDate;
            record.type = newType;
            record.amount = parseInt(newAmount);
            record.content = newContent;
            record.method = newMethod;
            record.note = newNote;
            
            displaySalesHistory();
            recalculateLTV();
        }

        // Â£≤‰∏äË®òÈå≤ÂâäÈô§
        function deleteSalesRecord(id) {
            if (!confirm('„Åì„ÅÆÂ£≤‰∏äË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            memberData.salesHistory = memberData.salesHistory.filter(r => r.id !== id);
            displaySalesHistory();
            recalculateLTV();
        }

        // LTVÂÜçË®àÁÆó
        function recalculateLTV() {
            let baseLTV = 0;
            let upsaleLTV = 0;
            
            memberData.salesHistory.forEach(record => {
                if (record.type === 'Âü∫Êú¨ÊñôÈáë' || record.type === 'Âπ¥ÈñìÊñôÈáë') {
                    baseLTV += record.amount;
                } else if (record.type === '„Ç¢„ÉÉ„Éó„Çª„É´') {
                    upsaleLTV += record.amount;
                }
            });
            
            memberData.baseLTV = baseLTV;
            memberData.upsaleLTV = upsaleLTV;
            memberData.totalLTV = baseLTV + upsaleLTV;
            
            // Ë°®Á§∫Êõ¥Êñ∞
            document.getElementById('baseLTV').textContent = `¬•${baseLTV.toLocaleString()}`;
            document.getElementById('upsaleLTV').textContent = `¬•${upsaleLTV.toLocaleString()}`;
            document.getElementById('totalLTV').textContent = `¬•${memberData.totalLTV.toLocaleString()}`;
        }

        // ÊúàË©≥Á¥∞Ë°®Á§∫
        function showMonthDetail(month) {
            const records = memberData.salesHistory.filter(r => r.date.startsWith(month));
            let detail = `${month}„ÅÆÂ£≤‰∏äË©≥Á¥∞:\n\n`;
            
            records.forEach(record => {
                detail += `${record.date} - ${record.type}: ¬•${record.amount.toLocaleString()} (${record.content})\n`;
            });
            
            alert(detail);
        }

        // LTVË©≥Á¥∞ÂÜÖË®≥Ë®àÁÆó„Å®Ë°®Á§∫
        function displayLTVBreakdown(member) {
            const breakdown = calculateLTVBreakdown(member);
            const container = document.getElementById('ltvBreakdown');
            
            let html = '<div style="font-size: 0.9em;">';
            
            // ‰ΩìÈ®ìÊúüÈñì
            if (breakdown.trial.months > 0) {
                html += `
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>üî∏ ‰ΩìÈ®ìÊúüÈñì (${breakdown.trial.period})</span>
                        <span style="font-weight: bold;">¬•${breakdown.trial.amount.toLocaleString()}</span>
                    </div>
                `;
            }
            
            // ÈÄöÂ∏∏‰ºöÂì°ÊúüÈñì
            if (breakdown.regular.months > 0) {
                html += `
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>‚≠ê ÈÄöÂ∏∏‰ºöÂì° ${breakdown.regular.months}„É∂Êúà (${breakdown.regular.period})</span>
                        <span style="font-weight: bold;">¬•${breakdown.regular.amount.toLocaleString()}</span>
                    </div>
                `;
            }
            
            // Âπ¥Èñì‰ºöÂì°ÊúüÈñì
            if (breakdown.annual.years > 0) {
                html += `
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>üíé Âπ¥Èñì‰ºöÂì° ${breakdown.annual.years}Âπ¥ (${breakdown.annual.period})</span>
                        <span style="font-weight: bold;">¬•${breakdown.annual.amount.toLocaleString()}</span>
                    </div>
                `;
            }
            
            // Â∞èË®à
            html += `
                <div style="border-top: 1px solid #dee2e6; padding-top: 8px; margin-top: 8px; display: flex; justify-content: space-between;">
                    <span><strong>Âü∫Êú¨ÊñôÈáëÂ∞èË®à</strong></span>
                    <span style="font-weight: bold; color: #17a2b8;">¬•${breakdown.basicTotal.toLocaleString()}</span>
                </div>
            `;
            
            // „Ç¢„ÉÉ„Éó„Çª„É´
            if (breakdown.upsell.total > 0) {
                html += `
                    <div style="margin-top: 8px; margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>üõí „Ç¢„ÉÉ„Éó„Çª„É´Â£≤‰∏ä</span>
                        <span style="font-weight: bold; color: #ff6b35;">¬•${breakdown.upsell.total.toLocaleString()}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Á∑èLTVË°®Á§∫
            document.getElementById('totalLTV').textContent = `¬•${breakdown.grandTotal.toLocaleString()}`;
        }

        // LTVÂÜÖË®≥Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
        function calculateLTVBreakdown(member) {
            const now = new Date();
            const joinDate = new Date(member.joinDate);
            const regularJoinDate = member.regularJoinDate ? new Date(member.regularJoinDate) : null;
            const annualPaymentDate = member.annualPaymentDate ? new Date(member.annualPaymentDate) : null;
            
            let breakdown = {
                trial: { months: 0, amount: 0, period: '' },
                regular: { months: 0, amount: 0, period: '' },
                annual: { years: 0, amount: 0, period: '' },
                upsell: { total: member.upsell || 0 },
                basicTotal: 0,
                grandTotal: 0
            };
            
            // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âü∫„Å•„ÅèË®àÁÆó
            if (member.status === '‰ΩìÈ®ìÁµÇ‰∫Ü') {
                // ‰ΩìÈ®ì„ÅÆ„Åø
                breakdown.trial.months = 1;
                breakdown.trial.amount = 3000;
                breakdown.trial.period = member.joinDate;
                
            } else if (member.status === 'ÈÄöÂ∏∏' || member.status === 'ÈÄÄ‰ºö') {
                // ‰ΩìÈ®ìÊúüÈñì
                breakdown.trial.months = 1;
                breakdown.trial.amount = 3000;
                breakdown.trial.period = member.joinDate;
                
                // ÈÄöÂ∏∏‰ºöÂì°ÊúüÈñì
                const regularStart = regularJoinDate || joinDate;
                const endDate = member.status === 'ÈÄÄ‰ºö' ? now : now; // ÂÆüÈöõ„ÅØÈÄÄ‰ºöÊó•„ÅåÂøÖË¶Å
                const monthsActive = Math.max(0, Math.floor((endDate - regularStart) / (1000 * 60 * 60 * 24 * 30)));
                
                breakdown.regular.months = monthsActive;
                breakdown.regular.amount = monthsActive * 22000;
                breakdown.regular.period = `${regularStart.toISOString().split('T')[0]} „Äú ÁèæÂú®`;
                
            } else if (member.status === 'Âπ¥Èñì') {
                // ‰ΩìÈ®ìÊúüÈñì
                breakdown.trial.months = 1;
                breakdown.trial.amount = 3000;
                breakdown.trial.period = member.joinDate;
                
                if (annualPaymentDate) {
                    // Âπ¥ÈñìÂàá„ÇäÊõø„ÅàÂâç„ÅÆÈÄöÂ∏∏ÊúüÈñì
                    const regularStart = regularJoinDate || joinDate;
                    if (annualPaymentDate > regularStart) {
                        const monthsRegular = Math.floor((annualPaymentDate - regularStart) / (1000 * 60 * 60 * 24 * 30));
                        breakdown.regular.months = monthsRegular;
                        breakdown.regular.amount = monthsRegular * 22000;
                        breakdown.regular.period = `${regularStart.toISOString().split('T')[0]} „Äú ${annualPaymentDate.toISOString().split('T')[0]}`;
                    }
                    
                    // Âπ¥ÈñìÊúüÈñì
                    const yearsActive = Math.max(1, Math.ceil((now - annualPaymentDate) / (1000 * 60 * 60 * 24 * 365)));
                    breakdown.annual.years = yearsActive;
                    breakdown.annual.amount = yearsActive * 220000;
                    breakdown.annual.period = `${annualPaymentDate.toISOString().split('T')[0]} „Äú ÁèæÂú®`;
                } else {
                    // Âπ¥ÈñìÊ±∫Ê∏àÊó•‰∏çÊòé„ÅÆÂ†¥Âêà„ÅØÂÖ®ÊúüÈñì„ÇíÂπ¥Èñì„Å®„Åó„Å¶Ë®àÁÆó
                    const yearsActive = Math.max(1, Math.ceil((now - joinDate) / (1000 * 60 * 60 * 24 * 365)));
                    breakdown.annual.years = yearsActive;
                    breakdown.annual.amount = yearsActive * 220000;
                    breakdown.annual.period = `${member.joinDate} „Äú ÁèæÂú®ÔºàÊé®ÂÆöÔºâ`;
                }
            }
            
            breakdown.basicTotal = breakdown.trial.amount + breakdown.regular.amount + breakdown.annual.amount;
            breakdown.grandTotal = breakdown.basicTotal + breakdown.upsell.total;
            
            return breakdown;
        }

        // Ë≥ºÂÖ•Â±•Ê≠¥Ë°®Á§∫Èñ¢Êï∞
        function displayPurchaseHistory(member) {
            const container = document.getElementById('purchaseHistory');
            
            if (!member.purchaseHistory || member.purchaseHistory.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; font-style: italic;">Ë≥ºÂÖ•Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // Ë≥ºÂÖ•Â±•Ê≠¥„ÇíÊó•‰ªòÈ†Ü„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
            const sortedHistory = [...member.purchaseHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            sortedHistory.forEach(purchase => {
                html += `
                    <div class="purchase-item">
                        <div class="purchase-date">${purchase.date}</div>
                        <div class="purchase-product">${purchase.product}</div>
                        <div class="purchase-amount">¬•${purchase.amount.toLocaleString()}</div>
                        <div class="purchase-type ${purchase.type === 'Âü∫Êú¨' ? 'basic' : 'upsell'}">${purchase.type}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>
