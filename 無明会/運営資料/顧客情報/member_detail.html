<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ³ãƒãƒ¼è©³ç´° - ç„¡æ˜ä¼š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f8f6f3 0%, #fff8dc 50%, #f5e6a3 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .member-info {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .info-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .monthly-sales {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .monthly-table th,
        .monthly-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .monthly-table th {
            background: #2c3e50;
            color: white;
            font-weight: bold;
        }

        .monthly-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .status-å¹´é–“ {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .status-é€šå¸¸ {
            background: #d1ecf1;
            color: #0c5460;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .status-é€€ä¼š, .status-ä½“é¨“çµ‚äº† {
            background: #495057;
            color: #fff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .upsale-info {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .upsale-title {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 10px;
        }

        /* ä¸‰æ¯’ãƒãƒ¼ãƒ ã®è‰²åˆ†ã‘ */
        .team-è²ªæ¬² { 
            background: #fff9c4; 
            color: #795548; 
            border: 1px solid #ffeb3b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-ç‹æš { 
            background: #ffebee; 
            color: #b71c1c; 
            border: 1px solid #f44336;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-æ„šç—´ { 
            background: #e8f5e8; 
            color: #2e7d32; 
            border: 1px solid #4caf50;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-ãªã— { 
            background: #e9ecef; 
            color: #6c757d; 
            border: 1px solid #6c757d;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .team-æœªè¨­å®š { 
            background: #fff; 
            color: #999; 
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* è³¼å…¥å±¥æ­´ã‚¹ã‚¿ã‚¤ãƒ« */
        .purchase-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 80px 1fr 100px 80px;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }

        .purchase-date {
            font-weight: bold;
            color: #495057;
        }

        .purchase-product {
            color: #212529;
        }

        .purchase-amount {
            text-align: right;
            font-weight: bold;
            color: #28a745;
        }

        .purchase-type {
            text-align: center;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .purchase-type.basic {
            background: #17a2b8;
            color: white;
        }

        .purchase-type.upsell {
            background: #ff6b35;
            color: white;
        }
    </style>
</head>
<body>
    <a href="ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹.html" class="back-btn">â† ä¸€è¦§ã«æˆ»ã‚‹</a>

    <div class="container">
        <div class="header">
            <h1 id="memberName">ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°</h1>
            <p id="memberId"></p>
        </div>

        <!-- æ¤œç´¢æ©Ÿèƒ½ -->
        <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff;">
            <h3 style="color: #007bff; margin-bottom: 10px; font-size: 1em;">ğŸ” ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</h3>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="åå‰ãƒ»èª­ã¿ä»®åãƒ»Discordåã§æ¤œç´¢..." 
                       style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                <button onclick="searchMembers()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">æ¤œç´¢</button>
                <button onclick="clearSearch()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="searchResults" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="member-info">
            <!-- åŸºæœ¬æƒ…å ± -->
            <div class="info-section">
                <h3>ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                <div class="info-row">
                    <span class="info-label">èª­ã¿ä»®å</span>
                    <span class="info-value" id="furigana"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                    <span class="info-value" id="status"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ä¸‰æ¯’ãƒãƒ¼ãƒ </span>
                    <span class="info-value" id="team"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">å…¥ä¼šæ—¥</span>
                    <span class="info-value" id="joinDate"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ­£è¦é–‹å§‹æ—¥</span>
                    <span class="info-value" id="regularJoinDate"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æœ€çµ‚æ´»å‹•</span>
                    <span class="info-value" id="lastActive"></span>
                </div>
            </div>

            <!-- LTVè©³ç´°æƒ…å ± -->
            <div class="info-section">
                <h3>ğŸ’° LTVè©³ç´°å†…è¨³</h3>
                <div id="ltvBreakdown" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <!-- LTVå†…è¨³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <div class="info-row" style="border-top: 2px solid #007bff; margin-top: 10px; padding-top: 10px;">
                    <span class="info-label" style="font-weight: bold; font-size: 1.1em;">ç·LTV</span>
                    <span class="info-value" id="totalLTV" style="font-weight: bold; color: #007bff; font-size: 1.2em;"></span>
                </div>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ã‚»ãƒ«è©³ç´° -->
            <div id="upsaleDetails" class="info-section" style="display: none;">
                <h3>ğŸ›’ ã‚¢ãƒƒãƒ—ã‚»ãƒ«è©³ç´°</h3>
                <div id="upsaleContent"></div>
            </div>

            <!-- Discordæƒ…å ± -->
            <div class="info-section">
                <h3>ğŸ’¬ Discordæƒ…å ±</h3>
                <div class="info-row">
                    <span class="info-label">Discordå</span>
                    <span class="info-value" id="discordName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Discord ID</span>
                    <span class="info-value" id="discordId"></span>
                </div>
            </div>

            <!-- è³¼å…¥å±¥æ­´ -->
            <div class="info-section">
                <h3>ğŸ›’ è³¼å…¥å±¥æ­´</h3>
                <div id="purchaseHistory" style="margin-top: 10px;">
                    <!-- è³¼å…¥å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- å£²ä¸Šå±¥æ­´ -->
            <div class="monthly-sales">
                <div class="info-section">
                    <h3>ğŸ“Š å£²ä¸Šå±¥æ­´ï¼ˆæ—¥åˆ¥ï¼‰</h3>
                    <div style="margin-bottom: 15px;">
                        <button onclick="addSalesRecord()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">+ å£²ä¸Šè¨˜éŒ²è¿½åŠ </button>
                        <button onclick="toggleView()" id="viewToggle" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px;">æœˆåˆ¥è¡¨ç¤º</button>
                    </div>
                    
                    <!-- æ—¥åˆ¥è©³ç´°è¡¨ç¤º -->
                    <div id="dailyView">
                        <table class="monthly-table">
                            <thead>
                                <tr>
                                    <th>æ—¥ä»˜</th>
                                    <th>å£²ä¸Šç¨®åˆ¥</th>
                                    <th>é‡‘é¡</th>
                                    <th>å†…å®¹</th>
                                    <th>æ”¯æ‰•æ–¹æ³•</th>
                                    <th>å‚™è€ƒ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="dailyData">
                                <!-- æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã¾ã™ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- æœˆåˆ¥ã‚µãƒãƒªãƒ¼è¡¨ç¤º -->
                    <div id="monthlyView" style="display: none;">
                        <table class="monthly-table">
                            <thead>
                                <tr>
                                    <th>å¹´æœˆ</th>
                                    <th>åŸºæœ¬æ–™é‡‘</th>
                                    <th>ã‚¢ãƒƒãƒ—ã‚»ãƒ«</th>
                                    <th>ãã®ä»–</th>
                                    <th>æœˆè¨ˆ</th>
                                    <th>è©³ç´°</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyData">
                                <!-- æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã¾ã™ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="three_poisons_team_mapping.js"></script>
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
        let memberData = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°ã‚’è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            if (memberId) {
                // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ã“ã“ã§ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                loadMemberData(memberId);
            } else {
                alert('ãƒ¡ãƒ³ãƒãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                window.location.href = 'ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹.html';
            }
        });

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function loadMemberData(id) {
            // å®Ÿéš›ã«ã¯ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼ˆlocalStorageåˆ©ç”¨æƒ³å®šï¼‰
            const memberFromDB = localStorage.getItem(`member_${id}`);
            if (memberFromDB) {
                const member = JSON.parse(memberFromDB);
                displayMemberDetail(member);
                return;
            }
            
            // ä»®ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ API ã‚„ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ï¼‰
            const sampleData = {
                id: id,
                name: 'æ¾ç”°é™½å¹³',
                currentStatus: 'é€šå¸¸',
                threePoisonsTeam: 'ç‹æš',
                joinDate: '2024-07-01',
                regularJoinDate: '2024-02-29',
                lastActive: '2025-07-29',
                baseLTV: 154000,
                upsaleLTV: 380000,
                totalLTV: 534000,
                discord: 'æ¾ç”°',
                discordId: 'matsuda123',
                upsales: [
                    {
                        name: 'å¾¹åº•ç²¾é€²',
                        totalAmount: 330000,
                        purchaseDate: '2025-06',
                        installments: 3,
                        monthlyAmount: 110000,
                        paidInstallments: 2,
                        remainingAmount: 110000,
                        nextPaymentDate: '2025-08-31',
                        status: 'åˆ†å‰²ä¸­'
                    },
                    {
                        name: 'NHBC1å¹´VIP',
                        totalAmount: 50000,
                        purchaseDate: '2025-07-16',
                        installments: 1,
                        monthlyAmount: 50000,
                        paidInstallments: 1,
                        remainingAmount: 0,
                        nextPaymentDate: null,
                        status: 'å®Œæ¸ˆ'
                    }
                ],
                salesHistory: [
                    { date: '2024-07-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: 'å…¥ä¼š', id: 1 },
                    { date: '2024-08-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 2 },
                    { date: '2024-09-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 3 },
                    { date: '2024-10-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 4 },
                    { date: '2024-11-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 5 },
                    { date: '2024-12-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 6 },
                    { date: '2025-01-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 7 },
                    { date: '2025-02-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 8 },
                    { date: '2025-03-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 9 },
                    { date: '2025-04-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 10 },
                    { date: '2025-05-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 11 },
                    { date: '2025-06-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 12 },
                    { date: '2025-06-15', type: 'ã‚¢ãƒƒãƒ—ã‚»ãƒ«', amount: 110000, content: 'å¾¹åº•ç²¾é€²', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: 'åˆ†å‰² 1/3', id: 13 },
                    { date: '2025-07-01', type: 'åŸºæœ¬æ–™é‡‘', amount: 22000, content: 'é€šå¸¸ä¼šå“¡', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: '', id: 14 },
                    { date: '2025-07-16', type: 'ã‚¢ãƒƒãƒ—ã‚»ãƒ«', amount: 50000, content: 'NHBC1å¹´VIP', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: 'ä¸€æ‹¬', id: 15 },
                    { date: '2025-07-31', type: 'ã‚¢ãƒƒãƒ—ã‚»ãƒ«', amount: 110000, content: 'å¾¹åº•ç²¾é€²', method: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', note: 'åˆ†å‰² 2/3', id: 16 },
                ]
            };

            displayMemberDetail(sampleData);
        }

        // ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°ã‚’è¡¨ç¤º
        function displayMemberDetail(member) {
            memberData = member;

            // åŸºæœ¬æƒ…å ±
            document.getElementById('memberName').textContent = member.name;
            document.getElementById('memberId').textContent = `ID: ${member.id}`;
            document.getElementById('status').innerHTML = `<span class="status-${member.currentStatus}">${member.currentStatus}</span>`;
            document.getElementById('team').innerHTML = `<span class="team-${member.threePoisonsTeam}">${member.threePoisonsTeam}</span>`;
            document.getElementById('joinDate').textContent = member.joinDate;
            document.getElementById('regularJoinDate').textContent = member.regularJoinDate;
            document.getElementById('lastActive').textContent = member.lastActive;

            // LTVè©³ç´°å†…è¨³è¡¨ç¤º
            displayLTVBreakdown(member);

            // Discordæƒ…å ±
            document.getElementById('discordName').textContent = member.discord || '-';
            document.getElementById('discordId').textContent = member.discordId || '-';

            // è³¼å…¥å±¥æ­´è¡¨ç¤º
            displayPurchaseHistory(member);

            // ã‚¢ãƒƒãƒ—ã‚»ãƒ«è©³ç´°
            if (member.upsales && member.upsales.length > 0) {
                const upsaleSection = document.getElementById('upsaleDetails');
                const upsaleContent = document.getElementById('upsaleContent');
                
                upsaleSection.style.display = 'block';
                
                member.upsales.forEach(upsale => {
                    const upsaleDiv = document.createElement('div');
                    upsaleDiv.className = 'upsale-info';
                    upsaleDiv.innerHTML = `
                        <div class="upsale-title">${upsale.name}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                            <div>è³¼å…¥æ—¥: ${upsale.purchaseDate}</div>
                            <div>ç·é¡: Â¥${upsale.totalAmount.toLocaleString()}</div>
                            <div>åˆ†å‰²: ${upsale.installments}å›</div>
                            <div>æœˆé¡: Â¥${upsale.monthlyAmount.toLocaleString()}</div>
                            <div>æ”¯æ‰•æ¸ˆ: ${upsale.paidInstallments}/${upsale.installments}å›</div>
                            <div>æ®‹é¡: Â¥${upsale.remainingAmount.toLocaleString()}</div>
                            <div>æ¬¡å›: ${upsale.nextPaymentDate}</div>
                            <div>çŠ¶æ…‹: ${upsale.status}</div>
                        </div>
                    `;
                    upsaleContent.appendChild(upsaleDiv);
                });
            }

            // æ—¥åˆ¥å£²ä¸Šå±¥æ­´ã‚’è¡¨ç¤º
            displaySalesHistory();
        }

        // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        let isMonthlyView = false;
        function toggleView() {
            const dailyView = document.getElementById('dailyView');
            const monthlyView = document.getElementById('monthlyView');
            const toggleBtn = document.getElementById('viewToggle');
            
            isMonthlyView = !isMonthlyView;
            
            if (isMonthlyView) {
                dailyView.style.display = 'none';
                monthlyView.style.display = 'block';
                toggleBtn.textContent = 'æ—¥åˆ¥è¡¨ç¤º';
                generateMonthlySummary();
            } else {
                dailyView.style.display = 'block';
                monthlyView.style.display = 'none';
                toggleBtn.textContent = 'æœˆåˆ¥è¡¨ç¤º';
            }
        }

        // æ—¥åˆ¥å£²ä¸Šå±¥æ­´ã‚’è¡¨ç¤º
        function displaySalesHistory() {
            const dailyTable = document.getElementById('dailyData');
            dailyTable.innerHTML = '';
            
            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedHistory = memberData.salesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedHistory.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span style="background: ${getTypeColor(record.type)}; padding: 2px 6px; border-radius: 3px; color: white; font-size: 0.8em;">${record.type}</span></td>
                    <td style="font-weight: bold;">Â¥${record.amount.toLocaleString()}</td>
                    <td>${record.content}</td>
                    <td>${record.method}</td>
                    <td>${record.note}</td>
                    <td>
                        <button onclick="editSalesRecord(${record.id})" style="background: #ffc107; color: black; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; margin-right: 5px;">ç·¨é›†</button>
                        <button onclick="deleteSalesRecord(${record.id})" style="background: #dc3545; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>
                    </td>
                `;
                dailyTable.appendChild(row);
            });
        }

        // å£²ä¸Šç¨®åˆ¥ã®è‰²åˆ†ã‘
        function getTypeColor(type) {
            switch (type) {
                case 'åŸºæœ¬æ–™é‡‘': return '#007bff';
                case 'ã‚¢ãƒƒãƒ—ã‚»ãƒ«': return '#28a745';
                case 'å¹´é–“æ–™é‡‘': return '#6f42c1';
                case 'ãã®ä»–': return '#6c757d';
                default: return '#6c757d';
            }
        }

        // æœˆåˆ¥ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
        function generateMonthlySummary() {
            const monthlyTable = document.getElementById('monthlyData');
            monthlyTable.innerHTML = '';
            
            // æœˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const monthlyData = {};
            memberData.salesHistory.forEach(record => {
                const month = record.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { base: 0, upsale: 0, other: 0, details: [] };
                }
                
                if (record.type === 'åŸºæœ¬æ–™é‡‘' || record.type === 'å¹´é–“æ–™é‡‘') {
                    monthlyData[month].base += record.amount;
                } else if (record.type === 'ã‚¢ãƒƒãƒ—ã‚»ãƒ«') {
                    monthlyData[month].upsale += record.amount;
                } else {
                    monthlyData[month].other += record.amount;
                }
                
                monthlyData[month].details.push(record);
            });
            
            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            sortedMonths.forEach(month => {
                const data = monthlyData[month];
                const total = data.base + data.upsale + data.other;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>Â¥${data.base.toLocaleString()}</td>
                    <td>Â¥${data.upsale.toLocaleString()}</td>
                    <td>Â¥${data.other.toLocaleString()}</td>
                    <td style="font-weight: bold;">Â¥${total.toLocaleString()}</td>
                    <td><button onclick="showMonthDetail('${month}')" style="background: #007bff; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer;">è©³ç´°</button></td>
                `;
                monthlyTable.appendChild(row);
            });
        }

        // å£²ä¸Šè¨˜éŒ²è¿½åŠ 
        function addSalesRecord() {
            const date = prompt('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (YYYY-MM-DD):');
            if (!date) return;
            
            const type = prompt('å£²ä¸Šç¨®åˆ¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (åŸºæœ¬æ–™é‡‘/ã‚¢ãƒƒãƒ—ã‚»ãƒ«/å¹´é–“æ–™é‡‘/ãã®ä»–):');
            if (!type) return;
            
            const amount = prompt('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!amount || isNaN(amount)) return;
            
            const content = prompt('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!content) return;
            
            const method = prompt('æ”¯æ‰•æ–¹æ³•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/éŠ€è¡ŒæŒ¯è¾¼/ç¾é‡‘/ãã®ä»–):');
            if (!method) return;
            
            const note = prompt('å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä»»æ„):') || '';
            
            const newRecord = {
                id: Math.max(...memberData.salesHistory.map(r => r.id)) + 1,
                date: date,
                type: type,
                amount: parseInt(amount),
                content: content,
                method: method,
                note: note
            };
            
            memberData.salesHistory.push(newRecord);
            displaySalesHistory();
            
            // LTVå†è¨ˆç®—
            recalculateLTV();
        }

        // å£²ä¸Šè¨˜éŒ²ç·¨é›†
        function editSalesRecord(id) {
            const record = memberData.salesHistory.find(r => r.id === id);
            if (!record) return;
            
            const newDate = prompt('æ—¥ä»˜:', record.date) || record.date;
            const newType = prompt('å£²ä¸Šç¨®åˆ¥:', record.type) || record.type;
            const newAmount = prompt('é‡‘é¡:', record.amount) || record.amount;
            const newContent = prompt('å†…å®¹:', record.content) || record.content;
            const newMethod = prompt('æ”¯æ‰•æ–¹æ³•:', record.method) || record.method;
            const newNote = prompt('å‚™è€ƒ:', record.note) || record.note;
            
            record.date = newDate;
            record.type = newType;
            record.amount = parseInt(newAmount);
            record.content = newContent;
            record.method = newMethod;
            record.note = newNote;
            
            displaySalesHistory();
            recalculateLTV();
        }

        // å£²ä¸Šè¨˜éŒ²å‰Šé™¤
        function deleteSalesRecord(id) {
            if (!confirm('ã“ã®å£²ä¸Šè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            memberData.salesHistory = memberData.salesHistory.filter(r => r.id !== id);
            displaySalesHistory();
            recalculateLTV();
        }

        // LTVå†è¨ˆç®—
        function recalculateLTV() {
            let baseLTV = 0;
            let upsaleLTV = 0;
            
            memberData.salesHistory.forEach(record => {
                if (record.type === 'åŸºæœ¬æ–™é‡‘' || record.type === 'å¹´é–“æ–™é‡‘') {
                    baseLTV += record.amount;
                } else if (record.type === 'ã‚¢ãƒƒãƒ—ã‚»ãƒ«') {
                    upsaleLTV += record.amount;
                }
            });
            
            memberData.baseLTV = baseLTV;
            memberData.upsaleLTV = upsaleLTV;
            memberData.totalLTV = baseLTV + upsaleLTV;
            
            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('baseLTV').textContent = `Â¥${baseLTV.toLocaleString()}`;
            document.getElementById('upsaleLTV').textContent = `Â¥${upsaleLTV.toLocaleString()}`;
            document.getElementById('totalLTV').textContent = `Â¥${memberData.totalLTV.toLocaleString()}`;
        }

        // æœˆè©³ç´°è¡¨ç¤º
        function showMonthDetail(month) {
            const records = memberData.salesHistory.filter(r => r.date.startsWith(month));
            let detail = `${month}ã®å£²ä¸Šè©³ç´°:\n\n`;
            
            records.forEach(record => {
                detail += `${record.date} - ${record.type}: Â¥${record.amount.toLocaleString()} (${record.content})\n`;
            });
            
            alert(detail);
        }

        // LTVè©³ç´°å†…è¨³è¨ˆç®—ã¨è¡¨ç¤º
        function displayLTVBreakdown(member) {
            const breakdown = calculateLTVBreakdown(member);
            const container = document.getElementById('ltvBreakdown');
            
            let html = '<div style="font-size: 0.9em;">';
            
            // ä½“é¨“æœŸé–“
            if (breakdown.trial.months > 0) {
                html += `
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>ğŸ”¸ ä½“é¨“æœŸé–“ (${breakdown.trial.period})</span>
                        <span style="font-weight: bold;">Â¥${breakdown.trial.amount.toLocaleString()}</span>
                    </div>
                `;
            }
            
            // é€šå¸¸ä¼šå“¡æœŸé–“
            if (breakdown.regular.months > 0) {
                html += `
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>â­ é€šå¸¸ä¼šå“¡ ${breakdown.regular.months}ãƒ¶æœˆ (${breakdown.regular.period})</span>
                        <span style="font-weight: bold;">Â¥${breakdown.regular.amount.toLocaleString()}</span>
                    </div>
                `;
            }
            
            // å¹´é–“ä¼šå“¡æœŸé–“
            if (breakdown.annual.years > 0) {
                html += `
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>ğŸ’ å¹´é–“ä¼šå“¡ ${breakdown.annual.years}å¹´ (${breakdown.annual.period})</span>
                        <span style="font-weight: bold;">Â¥${breakdown.annual.amount.toLocaleString()}</span>
                    </div>
                `;
            }
            
            // å°è¨ˆ
            html += `
                <div style="border-top: 1px solid #dee2e6; padding-top: 8px; margin-top: 8px; display: flex; justify-content: space-between;">
                    <span><strong>åŸºæœ¬æ–™é‡‘å°è¨ˆ</strong></span>
                    <span style="font-weight: bold; color: #17a2b8;">Â¥${breakdown.basicTotal.toLocaleString()}</span>
                </div>
            `;
            
            // ã‚¢ãƒƒãƒ—ã‚»ãƒ«
            if (breakdown.upsell.total > 0) {
                html += `
                    <div style="margin-top: 8px; margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>ğŸ›’ ã‚¢ãƒƒãƒ—ã‚»ãƒ«å£²ä¸Š</span>
                        <span style="font-weight: bold; color: #ff6b35;">Â¥${breakdown.upsell.total.toLocaleString()}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // ç·LTVè¡¨ç¤º
            document.getElementById('totalLTV').textContent = `Â¥${breakdown.grandTotal.toLocaleString()}`;
        }

        // LTVå†…è¨³è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function calculateLTVBreakdown(member) {
            const now = new Date();
            const joinDate = new Date(member.joinDate);
            const regularJoinDate = member.regularJoinDate ? new Date(member.regularJoinDate) : null;
            const annualPaymentDate = member.annualPaymentDate ? new Date(member.annualPaymentDate) : null;
            
            let breakdown = {
                trial: { months: 0, amount: 0, period: '' },
                regular: { months: 0, amount: 0, period: '' },
                annual: { years: 0, amount: 0, period: '' },
                upsell: { total: member.upsell || 0 },
                basicTotal: 0,
                grandTotal: 0
            };
            
            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ãè¨ˆç®—
            if (member.status === 'ä½“é¨“çµ‚äº†') {
                // ä½“é¨“ã®ã¿
                breakdown.trial.months = 1;
                breakdown.trial.amount = 3000;
                breakdown.trial.period = member.joinDate;
                
            } else if (member.status === 'é€šå¸¸' || member.status === 'é€€ä¼š') {
                // ä½“é¨“æœŸé–“
                breakdown.trial.months = 1;
                breakdown.trial.amount = 3000;
                breakdown.trial.period = member.joinDate;
                
                // é€šå¸¸ä¼šå“¡æœŸé–“
                const regularStart = regularJoinDate || joinDate;
                const endDate = member.status === 'é€€ä¼š' ? now : now; // å®Ÿéš›ã¯é€€ä¼šæ—¥ãŒå¿…è¦
                const monthsActive = Math.max(0, Math.floor((endDate - regularStart) / (1000 * 60 * 60 * 24 * 30)));
                
                breakdown.regular.months = monthsActive;
                breakdown.regular.amount = monthsActive * 22000;
                breakdown.regular.period = `${regularStart.toISOString().split('T')[0]} ã€œ ç¾åœ¨`;
                
            } else if (member.status === 'å¹´é–“') {
                // ä½“é¨“æœŸé–“
                breakdown.trial.months = 1;
                breakdown.trial.amount = 3000;
                breakdown.trial.period = member.joinDate;
                
                if (annualPaymentDate) {
                    // å¹´é–“åˆ‡ã‚Šæ›¿ãˆå‰ã®é€šå¸¸æœŸé–“
                    const regularStart = regularJoinDate || joinDate;
                    if (annualPaymentDate > regularStart) {
                        const monthsRegular = Math.floor((annualPaymentDate - regularStart) / (1000 * 60 * 60 * 24 * 30));
                        breakdown.regular.months = monthsRegular;
                        breakdown.regular.amount = monthsRegular * 22000;
                        breakdown.regular.period = `${regularStart.toISOString().split('T')[0]} ã€œ ${annualPaymentDate.toISOString().split('T')[0]}`;
                    }
                    
                    // å¹´é–“æœŸé–“
                    const yearsActive = Math.max(1, Math.ceil((now - annualPaymentDate) / (1000 * 60 * 60 * 24 * 365)));
                    breakdown.annual.years = yearsActive;
                    breakdown.annual.amount = yearsActive * 220000;
                    breakdown.annual.period = `${annualPaymentDate.toISOString().split('T')[0]} ã€œ ç¾åœ¨`;
                } else {
                    // å¹´é–“æ±ºæ¸ˆæ—¥ä¸æ˜ã®å ´åˆã¯å…¨æœŸé–“ã‚’å¹´é–“ã¨ã—ã¦è¨ˆç®—
                    const yearsActive = Math.max(1, Math.ceil((now - joinDate) / (1000 * 60 * 60 * 24 * 365)));
                    breakdown.annual.years = yearsActive;
                    breakdown.annual.amount = yearsActive * 220000;
                    breakdown.annual.period = `${member.joinDate} ã€œ ç¾åœ¨ï¼ˆæ¨å®šï¼‰`;
                }
            }
            
            breakdown.basicTotal = breakdown.trial.amount + breakdown.regular.amount + breakdown.annual.amount;
            breakdown.grandTotal = breakdown.basicTotal + breakdown.upsell.total;
            
            return breakdown;
        }

        // è³¼å…¥å±¥æ­´è¡¨ç¤ºé–¢æ•°
        function displayPurchaseHistory(member) {
            const container = document.getElementById('purchaseHistory');
            
            if (!member.purchaseHistory || member.purchaseHistory.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; font-style: italic;">è³¼å…¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // è³¼å…¥å±¥æ­´ã‚’æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedHistory = [...member.purchaseHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            sortedHistory.forEach(purchase => {
                html += `
                    <div class="purchase-item">
                        <div class="purchase-date">${purchase.date}</div>
                        <div class="purchase-product">${purchase.product}</div>
                        <div class="purchase-amount">Â¥${purchase.amount.toLocaleString()}</div>
                        <div class="purchase-type ${purchase.type === 'åŸºæœ¬' ? 'basic' : 'upsell'}">${purchase.type}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>
