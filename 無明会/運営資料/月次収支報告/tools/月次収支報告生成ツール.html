<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡æ˜ä¼š æœˆæ¬¡åæ”¯å ±å‘Šç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f8f6f3 0%, #fff8dc 50%, #f5e6a3 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f5e6a3 0%, #d4af37 50%, #b8860b 100%);
            color: #8b6914;
            padding: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: left;
        }

        .header-actions {
            text-align: right;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #8b6914;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .input-section {
            padding: 40px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .output-section {
            padding: 40px;
            background: white;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .member-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .date-inputs select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .date-inputs select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .output-area {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            overflow-y: auto;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.2s ease;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .save-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 15px;
            margin-left: 10px;
            transition: background-color 0.2s ease;
        }

        .save-btn:hover {
            background: #138496;
        }

        .transfer-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 15px;
            margin-left: 10px;
            transition: background-color 0.2s ease;
        }

        .transfer-btn:hover {
            background: #5a32a3;
        }

        /* æ¯”è¼ƒåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .comparison-section {
            background: white;
            padding: 40px;
            border-top: 1px solid #e9ecef;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .comparison-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .comparison-card:hover {
            border-color: #d4af37;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.1);
        }

        .comparison-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2em;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 10px;
        }

        .comparison-content {
            color: #6c757d;
            line-height: 1.6;
        }

        /* å±¥æ­´ãƒ»ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .history-section {
            background: #f8f9fa;
            padding: 40px;
        }

        .history-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            background: #e9ecef;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab-btn.active {
            background: #d4af37;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #dee2e6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .history-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .export-btn:hover {
            background: #218838;
        }

        .history-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            border: 2px solid #e9ecef;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        /* å±¥æ­´è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .history-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #d4af37;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-details {
            color: #6c757d;
            font-size: 0.9em;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .comparison-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #d4af37;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .help-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .input-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .member-inputs {
                grid-template-columns: 1fr;
            }
            
            .date-inputs {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-text {
                text-align: center;
            }

            .header-actions {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>ğŸ“Š ç„¡æ˜ä¼šåæ”¯å ±å‘Šç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>
                    <p>Discordã§å ±å‘Šã™ã‚‹æœˆæ¬¡ã®åæ”¯å ±å‘Šã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™</p>
                </div>
                <div class="header-actions">
                    <a href="å£²ä¸ŠçµŒè²»é›†è¨ˆãƒ„ãƒ¼ãƒ«.html" class="back-btn">ğŸ”„ é›†è¨ˆãƒ„ãƒ¼ãƒ«ã«æˆ»ã‚‹</a>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="input-section">
                <h2 class="section-title">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                
                <form id="reportForm">
                    <div class="form-group">
                        <label>1. å¯¾è±¡å¹´æœˆ</label>
                        <div class="date-inputs">
                            <div>
                                <label for="targetYear">å¹´</label>
                                <select id="targetYear" required>
                                    <option value="">å¹´ã‚’é¸æŠ</option>
                                </select>
                            </div>
                            <div>
                                <label for="targetMonth">æœˆ</label>
                                <select id="targetMonth" required>
                                    <option value="">æœˆã‚’é¸æŠ</option>
                                    <option value="1">1æœˆ</option>
                                    <option value="2">2æœˆ</option>
                                    <option value="3">3æœˆ</option>
                                    <option value="4">4æœˆ</option>
                                    <option value="5">5æœˆ</option>
                                    <option value="6">6æœˆ</option>
                                    <option value="7">7æœˆ</option>
                                    <option value="8">8æœˆ</option>
                                    <option value="9">9æœˆ</option>
                                    <option value="10">10æœˆ</option>
                                    <option value="11">11æœˆ</option>
                                    <option value="12">12æœˆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="help-text">å¯¾è±¡ã¨ãªã‚‹å¹´ã¨æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>

                    <div class="form-group">
                        <label for="sales">2. å£²ä¸Šé‡‘é¡</label>
                        <input type="text" id="sales" placeholder="ä¾‹ï¼š1234567 ã¾ãŸã¯ 1,234,567" required>
                        <div class="help-text">Â¥è¨˜å·ä¸è¦ã€ã‚«ãƒ³ãƒã‚ã‚Šã§ã‚‚OK</div>
                    </div>

                    <div class="form-group">
                        <label for="expenses">3. çµŒè²»é‡‘é¡</label>
                        <input type="text" id="expenses" placeholder="ä¾‹ï¼š234567 ã¾ãŸã¯ 234,567" required>
                        <div class="help-text">Â¥è¨˜å·ä¸è¦ã€ã‚«ãƒ³ãƒã‚ã‚Šã§ã‚‚OK</div>
                    </div>

                    <div class="form-group">
                        <label for="waypoint">4. waypointè² æ‹…é‡‘é¡</label>
                        <input type="text" id="waypoint" placeholder="ä¾‹ï¼š50000 ã¾ãŸã¯ 50,000" required>
                        <div class="help-text">Â¥è¨˜å·ä¸è¦ã€ã‚«ãƒ³ãƒã‚ã‚Šã§ã‚‚OK</div>
                    </div>

                    <div class="form-group">
                        <label>5. ä¼šå“¡æ•°ï¼ˆæœˆæœ«æ™‚ç‚¹ï¼‰</label>
                        <div class="member-inputs">
                            <div>
                                <label for="yearlyMembers">å¹´é–“</label>
                                <input type="number" id="yearlyMembers" placeholder="0" min="0" required>
                            </div>
                            <div>
                                <label for="regularMembers">é€šå¸¸</label>
                                <input type="number" id="regularMembers" placeholder="0" min="0" required>
                            </div>
                            <div>
                                <label for="trialMembers">ä½“é¨“</label>
                                <input type="number" id="trialMembers" placeholder="0" min="0" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="noteDonation">6. noteå¸ƒæ–½é‡‘é¡ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="noteDonation" placeholder="ä¾‹ï¼š10000 ã¾ãŸã¯ 10,000ï¼ˆãªã„å ´åˆã¯0ï¼‰" value="0">
                        <div class="help-text">ãªã„å ´åˆã¯0ã‚’å…¥åŠ›</div>
                    </div>

                    <div class="form-group">
                        <label for="specialNotes">7. ç‰¹è¨˜äº‹é …ï¼ˆä»»æ„ï¼‰</label>
                        <textarea id="specialNotes" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãªã‘ã‚Œã°ã€Œç‰¹è¨˜äº‹é …ãªã—ã€ã¨å…¥åŠ›ï¼‰">ç‰¹è¨˜äº‹é …ãªã—</textarea>
                    </div>

                    <button type="submit" class="generate-btn">ğŸ“Š åæ”¯å ±å‘Šã‚’ç”Ÿæˆ</button>
                </form>
                </form>
            </div>

            <div class="output-section">
                <h2 class="section-title">ğŸ“‹ ç”Ÿæˆçµæœ</h2>
                <div id="outputArea" class="output-area">
                    ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€Œåæ”¯å ±å‘Šã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                </div>
                <button id="copyBtn" class="copy-btn" style="display: none;">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                <button id="saveBtn" class="save-btn" style="display: none;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                <button id="transferBtn" class="transfer-btn" style="display: none;">ğŸ“¥ é›†è¨ˆãƒ„ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿è»¢é€</button>
                <button class="test-btn" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9em; cursor: pointer; margin-top: 15px; margin-left: 10px; transition: background-color 0.2s ease;">ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ä¿å­˜</button>
            </div>
        </div>

        <!-- æ¯”è¼ƒåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="comparison-section">
            <h2 class="section-title">ğŸ“Š æ¯”è¼ƒåˆ†æ</h2>
            <div class="comparison-grid">
                <div class="comparison-card">
                    <h3>ğŸ“ˆ å‰æœˆæ¯”è¼ƒ</h3>
                    <div id="monthComparison" class="comparison-content">
                        ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã¨å‰æœˆæ¯”è¼ƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="comparison-card">
                    <h3>ğŸ“… å‰å¹´åŒæœˆæ¯”è¼ƒ</h3>
                    <div id="yearComparison" class="comparison-content">
                        ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã¨å‰å¹´åŒæœˆæ¯”è¼ƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
            </div>
        </div>

        <!-- å±¥æ­´ãƒ»ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="history-section">
            <h2 class="section-title">ğŸ“š å±¥æ­´ãƒ»åˆ†æ</h2>
            <div class="history-tabs">
                <button class="tab-btn active" data-tab="history">ğŸ“‹ å±¥æ­´ä¸€è¦§</button>
                <button class="tab-btn" data-tab="charts">ğŸ“Š ã‚°ãƒ©ãƒ•åˆ†æ</button>
            </div>
            
            <div id="historyTab" class="tab-content active">
                <div class="history-controls">
                    <input type="text" id="searchInput" placeholder="å¹´æœˆã§æ¤œç´¢..." class="search-input">
                    <button id="exportBtn" class="export-btn">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
                <div id="historyList" class="history-list">
                    ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            </div>
            
            <div id="chartsTab" class="tab-content">
                <div class="chart-container">
                    <canvas id="salesChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="membersChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateReport();
        });

        document.getElementById('copyBtn').addEventListener('click', function() {
            copyToClipboard();
        });

        document.getElementById('saveBtn').addEventListener('click', function() {
            saveMonthlyData();
        });

        document.getElementById('transferBtn').addEventListener('click', function() {
            transferDataFromAggregation();
        });

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('test-btn')) {
                loadTestDataToReport();
            }
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                switchTab(tabName);
            });
        });

        // æ¤œç´¢æ©Ÿèƒ½
        document.getElementById('searchInput').addEventListener('input', function() {
            filterHistory(this.value);
        });

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        document.getElementById('exportBtn').addEventListener('click', function() {
            exportData();
        });

        function generateReport() {
            // å…¥åŠ›å€¤ã‚’å–å¾—
            const targetYear = document.getElementById('targetYear').value;
            const targetMonth = document.getElementById('targetMonth').value;
            const targetMonthText = targetYear + 'å¹´' + targetMonth + 'æœˆ';
            const sales = parseNumber(document.getElementById('sales').value);
            const expenses = parseNumber(document.getElementById('expenses').value);
            const waypoint = parseNumber(document.getElementById('waypoint').value);
            const yearlyMembers = parseInt(document.getElementById('yearlyMembers').value) || 0;
            const regularMembers = parseInt(document.getElementById('regularMembers').value) || 0;
            const trialMembers = parseInt(document.getElementById('trialMembers').value) || 0;
            const noteDonation = parseNumber(document.getElementById('noteDonation').value) || 0;
            const specialNotes = document.getElementById('specialNotes').value || 'ç‰¹è¨˜äº‹é …ãªã—';

            // è¨ˆç®—
            const profit = sales - expenses;
            const profitRate = sales > 0 ? (profit / sales) * 100 : 0;
            const profitHalf = profit / 2;
            const waypointHalf = waypoint / 2;
            const noteDonationHalf = noteDonation / 2;
            const totalTransfer = profitHalf + waypointHalf + noteDonationHalf;
            const totalMembers = yearlyMembers + regularMembers + trialMembers;

            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
            function formatCurrency(amount) {
                return 'Â¥' + amount.toLocaleString();
            }

            function formatPercentage(rate) {
                return rate.toFixed(2) + 'ï¼…';
            }

            // å ±å‘Šæ–‡ã‚’ç”Ÿæˆ
            const report = `@ryu.takami @ny8888  
ã€${targetMonthText}ã®åæ”¯ï¼†æŒ¯ã‚Šè¾¼ã¿å ±å‘Šã§ã™ã€‘

â–  ä¼šå“¡æ•°ï¼ˆ${targetMonthText}æœˆæœ«æ™‚ç‚¹ï¼‰  
åˆè¨ˆï¼š${totalMembers}å  
â”” å¹´é–“ï¼š${yearlyMembers}å  
â”” é€šå¸¸ï¼š${regularMembers}å  
â”” ä½“é¨“ï¼š${trialMembers}å

â–  åæ”¯ã‚µãƒãƒª  
å£²ä¸Šã€€ã€€ï¼š${formatCurrency(sales)}  
çµŒè²»ã€€ã€€ï¼š${formatCurrency(expenses)}  
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
åˆ©ç›Šã€€ã€€ï¼š${formatCurrency(profit)}  
åˆ©ç›Šç‡ã€€ï¼š${formatPercentage(profitRate)}

â–  æŠ˜åŠãƒ»é€é‡‘é‡‘é¡  
åˆ©ç›ŠæŠ˜åŠã€€ã€€ã€€ã€€ã€€ï¼š${formatCurrency(profitHalf)}  
waypointè² æ‹…æŠ˜åŠã€€ï¼š${formatCurrency(waypointHalf)}  
noteå¸ƒæ–½æŠ˜åŠã€€ã€€ã€€ï¼š${formatCurrency(noteDonationHalf)}

â†’ **é€é‡‘é¡åˆè¨ˆï¼š${formatCurrency(totalTransfer)}**  
ï¼ˆåˆ©ç›ŠæŠ˜åŠ + waypointè² æ‹…æŠ˜åŠ + å¸ƒæ–½æŠ˜åŠï¼‰  
â€»ä¼šè¨ˆã«å…±æœ‰æ¸ˆã¿ã§ã™ã€‚

---

ã€ç‰¹è¨˜äº‹é …ã€‘  
${specialNotes}

---

ğŸ“ å…ƒãƒ‡ãƒ¼ã‚¿  
ãƒ»åæ”¯ä¸€è¦§ï¼š<https://docs.google.com/spreadsheets/d/1LIrr7KrhtJtjNqODprvcVcw8W8WrmAQ80UJHK962G5k/edit?usp=sharing>  
ãƒ»å£²ä¸Šãƒ»æ‰‹æ•°æ–™ï¼š<https://docs.google.com/spreadsheets/d/1FYBDB1npx0ggRmAcTpqtyZsPXkOuzUKrQ0UoUVhKIXM/edit?usp=sharing>  
ãƒ»noteãƒ»å¾¹åº•ç²¾é€²å£²ä¸Šï¼š<https://docs.google.com/spreadsheets/d/1I6A4M3MPf1qMZqJjq6KOkmRbwTbvw0jG8CdHmHwT_Ck/edit?usp=sharing>`;

            // å‡ºåŠ›ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            document.getElementById('outputArea').textContent = report;
            document.getElementById('copyBtn').style.display = 'block';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('transferBtn').style.display = 'inline-block';
        }

        // é›†è¨ˆãƒ„ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€
        function transferDataFromAggregation() {
            const tempSales = localStorage.getItem('temp_sales');
            const tempExpenses = localStorage.getItem('temp_expenses');
            
            if (tempSales && tempExpenses) {
                // ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›
                document.getElementById('sales').value = parseInt(tempSales).toLocaleString();
                document.getElementById('expenses').value = parseInt(tempExpenses).toLocaleString();
                
                // è‡ªå‹•ã§å ±å‘Šã‚’ç”Ÿæˆ
                generateReport();
                
                // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem('temp_sales');
                localStorage.removeItem('temp_expenses');
                
                alert('é›†è¨ˆãƒ„ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã—ã¾ã—ãŸï¼');
            } else {
                alert('é›†è¨ˆãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«é›†è¨ˆãƒ„ãƒ¼ãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveMonthlyData() {
            const targetYear = document.getElementById('targetYear').value;
            const targetMonth = document.getElementById('targetMonth').value;
            const sales = parseNumber(document.getElementById('sales').value);
            const expenses = parseNumber(document.getElementById('expenses').value);
            const waypoint = parseNumber(document.getElementById('waypoint').value);
            const yearlyMembers = parseInt(document.getElementById('yearlyMembers').value) || 0;
            const regularMembers = parseInt(document.getElementById('regularMembers').value) || 0;
            const trialMembers = parseInt(document.getElementById('trialMembers').value) || 0;
            const noteDonation = parseNumber(document.getElementById('noteDonation').value) || 0;
            const specialNotes = document.getElementById('specialNotes').value || 'ç‰¹è¨˜äº‹é …ãªã—';

            const data = {
                year: parseInt(targetYear),
                month: parseInt(targetMonth),
                sales: sales,
                expenses: expenses,
                waypoint: waypoint,
                profit: sales - expenses,
                profitRate: sales > 0 ? ((sales - expenses) / sales) * 100 : 0,
                yearlyMembers: yearlyMembers,
                regularMembers: regularMembers,
                trialMembers: trialMembers,
                totalMembers: yearlyMembers + regularMembers + trialMembers,
                noteDonation: noteDonation,
                specialNotes: specialNotes,
                timestamp: new Date().toISOString()
            };

            const key = `monthly_report_${targetYear}_${targetMonth}`;
            localStorage.setItem(key, JSON.stringify(data));
            
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            updateComparison();
            updateHistory();
        }

        // æ¯”è¼ƒåˆ†æã‚’æ›´æ–°
        function updateComparison() {
            const currentYear = parseInt(document.getElementById('targetYear').value);
            const currentMonth = parseInt(document.getElementById('targetMonth').value);
            
            // å‰æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let prevMonth = currentMonth - 1;
            let prevYear = currentYear;
            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear = currentYear - 1;
            }
            
            const prevKey = `monthly_report_${prevYear}_${prevMonth}`;
            const prevData = JSON.parse(localStorage.getItem(prevKey) || 'null');
            
            // å‰å¹´åŒæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const prevYearKey = `monthly_report_${currentYear - 1}_${currentMonth}`;
            const prevYearData = JSON.parse(localStorage.getItem(prevYearKey) || 'null');
            
            // å‰æœˆæ¯”è¼ƒã‚’è¡¨ç¤º
            if (prevData) {
                const salesGrowth = ((currentData.sales - prevData.sales) / prevData.sales * 100).toFixed(1);
                const profitGrowth = ((currentData.profit - prevData.profit) / prevData.profit * 100).toFixed(1);
                const membersGrowth = ((currentData.totalMembers - prevData.totalMembers) / prevData.totalMembers * 100).toFixed(1);
                
                document.getElementById('monthComparison').innerHTML = `
                    <div class="comparison-item">
                        <strong>å£²ä¸Š:</strong> ${salesGrowth > 0 ? '+' : ''}${salesGrowth}%
                    </div>
                    <div class="comparison-item">
                        <strong>åˆ©ç›Š:</strong> ${profitGrowth > 0 ? '+' : ''}${profitGrowth}%
                    </div>
                    <div class="comparison-item">
                        <strong>ä¼šå“¡æ•°:</strong> ${membersGrowth > 0 ? '+' : ''}${membersGrowth}%
                    </div>
                `;
            } else {
                document.getElementById('monthComparison').innerHTML = 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            }
            
            // å‰å¹´åŒæœˆæ¯”è¼ƒã‚’è¡¨ç¤º
            if (prevYearData) {
                const salesGrowth = ((currentData.sales - prevYearData.sales) / prevYearData.sales * 100).toFixed(1);
                const profitGrowth = ((currentData.profit - prevYearData.profit) / prevYearData.profit * 100).toFixed(1);
                const membersGrowth = ((currentData.totalMembers - prevYearData.totalMembers) / prevYearData.totalMembers * 100).toFixed(1);
                
                document.getElementById('yearComparison').innerHTML = `
                    <div class="comparison-item">
                        <strong>å£²ä¸Š:</strong> ${salesGrowth > 0 ? '+' : ''}${salesGrowth}%
                    </div>
                    <div class="comparison-item">
                        <strong>åˆ©ç›Š:</strong> ${profitGrowth > 0 ? '+' : ''}${profitGrowth}%
                    </div>
                    <div class="comparison-item">
                        <strong>ä¼šå“¡æ•°:</strong> ${membersGrowth > 0 ? '+' : ''}${membersGrowth}%
                    </div>
                `;
            } else {
                document.getElementById('yearComparison').innerHTML = 'å‰å¹´åŒæœˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            }
        }

        function parseNumber(value) {
            if (!value) return 0;
            return parseInt(value.replace(/[^\d]/g, ''));
        }

        function copyToClipboard() {
            const outputArea = document.getElementById('outputArea');
            const text = outputArea.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const copyBtn = document.getElementById('copyBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                copyBtn.style.background = '#28a745';
                
                setTimeout(function() {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#28a745';
                }, 2000);
            }).catch(function(err) {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            });
        }

        // å…¥åŠ›å€¤ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function addNumberFormatting() {
            const numberInputs = ['sales', 'expenses', 'waypoint', 'noteDonation'];
            
            numberInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^\d]/g, '');
                    if (value) {
                        value = parseInt(value).toLocaleString();
                    }
                    e.target.value = value;
                });
            });
        }

        // å¹´ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
        function generateYearOptions() {
            const yearSelect = document.getElementById('targetYear');
            const currentYear = new Date().getFullYear();
            
            // éå»5å¹´ã‹ã‚‰æœªæ¥2å¹´ã¾ã§ç”Ÿæˆ
            for (let year = currentYear - 5; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                yearSelect.appendChild(option);
            }
        }

        // ç¾åœ¨ã®å¹´æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠ
        function setDefaultDate() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // 0ãƒ™ãƒ¼ã‚¹ãªã®ã§+1
            
            document.getElementById('targetYear').value = currentYear;
            document.getElementById('targetMonth').value = currentMonth;
        }

        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            const keys = Object.keys(localStorage).filter(key => key.startsWith('monthly_report_'));
            
            if (keys.length === 0) {
                historyList.innerHTML = 'ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
                return;
            }
            
            // å¹´æœˆé †ã«ã‚½ãƒ¼ãƒˆ
            keys.sort((a, b) => {
                const [, yearA, monthA] = a.split('_');
                const [, yearB, monthB] = b.split('_');
                return parseInt(yearB) - parseInt(yearA) || parseInt(monthB) - parseInt(monthA);
            });
            
            let html = '<div class="history-items">';
            keys.forEach(key => {
                const data = JSON.parse(localStorage.getItem(key));
                const [, year, month] = key.split('_');
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <strong>${year}å¹´${month}æœˆ</strong>
                            <button onclick="deleteData('${key}')" class="delete-btn">ğŸ—‘ï¸</button>
                        </div>
                        <div class="history-details">
                            å£²ä¸Š: Â¥${data.sales.toLocaleString()} | åˆ©ç›Š: Â¥${data.profit.toLocaleString()} | ä¼šå“¡æ•°: ${data.totalMembers}å
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            historyList.innerHTML = html;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        function deleteData(key) {
            if (confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(key);
                updateHistory();
                updateComparison();
            }
        }

        // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // å±¥æ­´ã‚’æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterHistory(searchTerm) {
            const historyItems = document.querySelectorAll('.history-item');
            historyItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const keys = Object.keys(localStorage).filter(key => key.startsWith('monthly_report_'));
            const data = keys.map(key => JSON.parse(localStorage.getItem(key)));
            
            const csv = [
                ['å¹´', 'æœˆ', 'å£²ä¸Š', 'çµŒè²»', 'åˆ©ç›Š', 'åˆ©ç›Šç‡', 'ä¼šå“¡æ•°', 'waypoint', 'noteå¸ƒæ–½', 'ç‰¹è¨˜äº‹é …'],
                ...data.map(item => [
                    item.year,
                    item.month,
                    item.sales,
                    item.expenses,
                    item.profit,
                    item.profitRate.toFixed(2),
                    item.totalMembers,
                    item.waypoint,
                    item.noteDonation,
                    item.specialNotes
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç„¡æ˜ä¼šæœˆæ¬¡åæ”¯å ±å‘Š_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ä¿å­˜æ©Ÿèƒ½
        function loadTestDataToReport() {
            const testData = [
                {
                    year: 2024,
                    month: 12,
                    sales: 1135000,
                    expenses: 528500,
                    waypoint: 50000,
                    yearlyMembers: 2,
                    regularMembers: 5,
                    trialMembers: 0,
                    noteDonation: 10000,
                    specialNotes: 'äº‹æ¥­é–‹å§‹æœˆ'
                },
                {
                    year: 2025,
                    month: 1,
                    sales: 1736000,
                    expenses: 650000,
                    waypoint: 55000,
                    yearlyMembers: 5,
                    regularMembers: 13,
                    trialMembers: 0,
                    noteDonation: 15000,
                    specialNotes: 'æ–°å¹´ã‚¹ã‚¿ãƒ¼ãƒˆ'
                },
                {
                    year: 2025,
                    month: 2,
                    sales: 2380000,
                    expenses: 770000,
                    waypoint: 60000,
                    yearlyMembers: 8,
                    regularMembers: 25,
                    trialMembers: 0,
                    noteDonation: 20000,
                    specialNotes: 'é †èª¿ãªæˆé•·'
                },
                {
                    year: 2025,
                    month: 3,
                    sales: 3390000,
                    expenses: 880000,
                    waypoint: 65000,
                    yearlyMembers: 13,
                    regularMembers: 40,
                    trialMembers: 0,
                    noteDonation: 25000,
                    specialNotes: 'æ˜¥ã®æˆé•·æœŸ'
                },
                {
                    year: 2025,
                    month: 4,
                    sales: 4616000,
                    expenses: 992000,
                    waypoint: 70000,
                    yearlyMembers: 19,
                    regularMembers: 58,
                    trialMembers: 0,
                    noteDonation: 30000,
                    specialNotes: 'æ€¥æˆé•·æœŸ'
                }
            ];

            let savedCount = 0;
            testData.forEach(data => {
                const key = `monthly_report_${data.year}_${data.month}`;
                const reportData = {
                    year: data.year,
                    month: data.month,
                    sales: data.sales,
                    expenses: data.expenses,
                    waypoint: data.waypoint,
                    profit: data.sales - data.expenses,
                    profitRate: data.sales > 0 ? ((data.sales - data.expenses) / data.sales) * 100 : 0,
                    yearlyMembers: data.yearlyMembers,
                    regularMembers: data.regularMembers,
                    trialMembers: data.trialMembers,
                    totalMembers: data.yearlyMembers + data.regularMembers + data.trialMembers,
                    noteDonation: data.noteDonation,
                    specialNotes: data.specialNotes,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem(key, JSON.stringify(reportData));
                savedCount++;
            });

            alert(`${savedCount}ãƒ¶æœˆåˆ†ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\nä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:\n- 2024å¹´12æœˆ\n- 2025å¹´1æœˆ\n- 2025å¹´2æœˆ\n- 2025å¹´3æœˆ\n- 2025å¹´4æœˆ\n\nå±¥æ­´ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚`);
            updateHistory();
        }



        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            generateYearOptions();
            setDefaultDate();
            addNumberFormatting();
            updateHistory();
        });
    </script>
</body>
</html>
